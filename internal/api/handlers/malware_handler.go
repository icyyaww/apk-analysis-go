package handlers

import (
	"encoding/json"
	"net/http"

	"github.com/apk-analysis/apk-analysis-go/internal/malware"
	"github.com/apk-analysis/apk-analysis-go/internal/repository"
	"github.com/apk-analysis/apk-analysis-go/internal/service"
	"github.com/gin-gonic/gin"
	"github.com/sirupsen/logrus"
)

// MalwareHandler 恶意检测 API 处理器
type MalwareHandler struct {
	taskService  service.TaskService
	malwareRepo  repository.MalwareRepository
	malwareDetector *malware.Detector
	logger       *logrus.Logger
}

// NewMalwareHandler 创建恶意检测处理器
func NewMalwareHandler(
	taskService service.TaskService,
	malwareRepo repository.MalwareRepository,
	malwareDetector *malware.Detector,
	logger *logrus.Logger,
) *MalwareHandler {
	return &MalwareHandler{
		taskService:     taskService,
		malwareRepo:     malwareRepo,
		malwareDetector: malwareDetector,
		logger:          logger,
	}
}

// GetMalwareDetection 获取任务的恶意检测结果
// GET /api/tasks/:id/malware-detection
func (h *MalwareHandler) GetMalwareDetection(c *gin.Context) {
	taskID := c.Param("id")

	// 检查任务是否存在
	task, err := h.taskService.GetTask(c.Request.Context(), taskID)
	if err != nil {
		c.JSON(http.StatusNotFound, gin.H{
			"error": "任务不存在",
		})
		return
	}

	// 获取恶意检测结果
	result, err := h.malwareRepo.GetByTaskID(c.Request.Context(), taskID)
	if err != nil {
		c.JSON(http.StatusNotFound, gin.H{
			"error": "恶意检测结果不存在",
		})
		return
	}

	// 解析 JSON 字段
	response := h.buildMalwareResponse(result, task.APKName)
	c.JSON(http.StatusOK, response)
}

// GetMalwareStatistics 获取恶意检测统计信息
// GET /api/malware/statistics
func (h *MalwareHandler) GetMalwareStatistics(c *gin.Context) {
	stats, err := h.malwareRepo.GetStatistics(c.Request.Context())
	if err != nil {
		h.logger.WithError(err).Error("Failed to get malware statistics")
		c.JSON(http.StatusInternalServerError, gin.H{
			"error": "获取恶意检测统计失败",
		})
		return
	}

	c.JSON(http.StatusOK, stats)
}

// GetRecentMalware 获取最近检测到的恶意软件
// GET /api/malware/recent
func (h *MalwareHandler) GetRecentMalware(c *gin.Context) {
	limit := 20
	if l := c.DefaultQuery("limit", "20"); l != "" {
		if parsed, err := parseInt(l); err == nil && parsed > 0 && parsed <= 100 {
			limit = parsed
		}
	}

	results, err := h.malwareRepo.GetRecentMalware(c.Request.Context(), limit)
	if err != nil {
		h.logger.WithError(err).Error("Failed to get recent malware")
		c.JSON(http.StatusInternalServerError, gin.H{
			"error": "获取最近恶意软件失败",
		})
		return
	}

	// 构建响应列表
	var items []gin.H
	for _, r := range results {
		items = append(items, gin.H{
			"task_id":          r.TaskID,
			"apk_name":         r.APKName,
			"is_malware":       r.IsMalware,
			"confidence":       r.Confidence,
			"predicted_family": r.PredictedFamily,
			"detected_at":      r.DetectedAt,
		})
	}

	c.JSON(http.StatusOK, gin.H{
		"items": items,
		"total": len(items),
	})
}

// GetMalwareServiceStatus 获取恶意检测服务状态
// GET /api/malware/status
func (h *MalwareHandler) GetMalwareServiceStatus(c *gin.Context) {
	if h.malwareDetector == nil {
		c.JSON(http.StatusOK, gin.H{
			"enabled":   false,
			"available": false,
			"error":     "Malware detector not configured",
		})
		return
	}

	// 检查服务可用性
	err := h.malwareDetector.CheckAvailability(c.Request.Context())
	if err != nil {
		c.JSON(http.StatusOK, gin.H{
			"enabled":   h.malwareDetector.IsEnabled(),
			"available": false,
			"error":     err.Error(),
		})
		return
	}

	c.JSON(http.StatusOK, gin.H{
		"enabled":   h.malwareDetector.IsEnabled(),
		"available": true,
	})
}

// RunMalwareDetection 手动触发恶意检测
// POST /api/tasks/:id/malware-detection/run
func (h *MalwareHandler) RunMalwareDetection(c *gin.Context) {
	taskID := c.Param("id")

	// 检查任务是否存在
	task, err := h.taskService.GetTask(c.Request.Context(), taskID)
	if err != nil {
		c.JSON(http.StatusNotFound, gin.H{
			"error": "任务不存在",
		})
		return
	}

	// 检查检测器是否可用
	if h.malwareDetector == nil || !h.malwareDetector.IsEnabled() {
		c.JSON(http.StatusServiceUnavailable, gin.H{
			"error": "恶意检测服务未启用",
		})
		return
	}

	// 构建 APK 路径
	apkPath := "./inbound_apks/" + task.APKName

	// 执行检测
	result, err := h.malwareDetector.Detect(
		c.Request.Context(),
		apkPath,
		malware.WithTaskID(taskID),
	)

	if err != nil {
		h.logger.WithError(err).WithField("task_id", taskID).Error("Malware detection failed")
		c.JSON(http.StatusInternalServerError, gin.H{
			"error": "恶意检测失败: " + err.Error(),
		})
		return
	}

	// 保存结果
	if err := h.malwareRepo.Upsert(c.Request.Context(), result); err != nil {
		h.logger.WithError(err).Error("Failed to save malware detection result")
	}

	// 构建响应
	response := h.buildMalwareResponse(result, task.APKName)
	c.JSON(http.StatusOK, response)
}

// buildMalwareResponse 构建恶意检测响应
func (h *MalwareHandler) buildMalwareResponse(result *malware.TaskMalwareResult, apkName string) gin.H {
	response := gin.H{
		"task_id":             result.TaskID,
		"apk_name":            apkName,
		"status":              result.Status,
		"is_malware":          result.IsMalware,
		"confidence":          result.Confidence,
		"malware_probability": result.MalwareProbability,
		"benign_probability":  result.BenignProbability,
		"predicted_family":    result.PredictedFamily,
		"feature_source":      result.FeatureSource,
		"extraction_time_ms":  result.ExtractionTimeMs,
		"inference_time_ms":   result.InferenceTimeMs,
		"total_time_ms":       result.TotalTimeMs,
		"detected_at":         result.DetectedAt,
		"created_at":          result.CreatedAt,
	}

	// 解析 JSON 字段
	if result.FamilyProbabilities != "" {
		var familyProbs []malware.FamilyProbability
		if err := json.Unmarshal([]byte(result.FamilyProbabilities), &familyProbs); err == nil {
			response["family_probabilities"] = familyProbs
		}
	}

	if result.DrebinResult != "" {
		var drebin malware.ModelResult
		if err := json.Unmarshal([]byte(result.DrebinResult), &drebin); err == nil {
			response["drebin_result"] = drebin
		}
	}

	if result.MH100KResult != "" {
		var mh100k malware.ModelResult
		if err := json.Unmarshal([]byte(result.MH100KResult), &mh100k); err == nil {
			response["mh100k_result"] = mh100k
		}
	}

	if result.CICMalDroidResult != "" {
		var cicmaldroid malware.ModelResult
		if err := json.Unmarshal([]byte(result.CICMalDroidResult), &cicmaldroid); err == nil {
			response["cicmaldroid_result"] = cicmaldroid
		}
	}

	if result.EnsembleResult != "" {
		var ensemble malware.EnsembleResult
		if err := json.Unmarshal([]byte(result.EnsembleResult), &ensemble); err == nil {
			response["ensemble_result"] = ensemble
		}
	}

	if result.FeatureSummary != "" {
		var features malware.FeatureSummary
		if err := json.Unmarshal([]byte(result.FeatureSummary), &features); err == nil {
			response["feature_summary"] = features
		}
	}

	if result.ErrorMessage != "" {
		response["error_message"] = result.ErrorMessage
	}

	return response
}

// parseInt 解析整数
func parseInt(s string) (int, error) {
	var n int
	err := json.Unmarshal([]byte(s), &n)
	if err != nil {
		// 尝试直接解析
		n = 0
		for _, c := range s {
			if c >= '0' && c <= '9' {
				n = n*10 + int(c-'0')
			} else {
				return 0, err
			}
		}
	}
	return n, nil
}
