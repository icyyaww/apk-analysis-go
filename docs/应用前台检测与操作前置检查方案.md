# 应用前台检测 + 操作前置检查方案

> **创建时间**：2025-11-27
> **状态**：实施中
> **目标**：解决动态分析中误操作导致应用退出的问题

---

## 一、问题描述

在动态执行 Activity 和 AI 智能点击时，容易误操作导致：
1. 点击到系统导航栏（返回/Home/最近任务）
2. 点击到通知栏或状态栏
3. 点击到悬浮窗或广告跳转到其他应用
4. 滑动手势触发系统功能

**后果**：
- Activity 分析数据被污染
- 流量归因错误
- 分析任务中断或失败

---

## 二、解决方案

采用 **"操作前检查 + 操作后恢复"** 的双重保护机制。

### 2.1 整体流程

```
┌─────────────────────────────────────────────────────────────┐
│                      操作执行流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │ 1.操作前检查 │───▶│ 2.执行操作  │───▶│ 3.操作后恢复 │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│        │                  │                  │              │
│        ▼                  ▼                  ▼              │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │ 检查目标元素 │    │  执行点击   │    │ 检测前台应用 │     │
│  │ 是否属于目标 │    │  /滑动/输入 │    │ 是否是目标   │     │
│  │ 应用包名    │    │             │    │ 应用包名     │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│        │                                     │              │
│        ▼                                     ▼              │
│   危险元素？───是──▶ 跳过此操作         不是目标应用？       │
│        │                                     │              │
│       否                                    是              │
│        │                                     │              │
│        ▼                                     ▼              │
│   继续执行                              自动恢复流程         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 操作前置检查（PreCheck）

**触发时机**：每次 AI 生成点击/滑动操作后，执行操作前

**检查流程**：
1. 获取当前 UI 层级（复用已有的 dump）
2. 根据坐标查找对应元素
3. 检查元素的 package 属性
4. 判断是否允许执行

**判断规则**：
- `package == 目标包名` → 允许执行
- `package == 系统包名` → 拒绝（导航栏等）
- `package == 其他应用` → 拒绝（悬浮窗/广告）
- `package 为空` → 检查坐标是否在安全区域

**危险包名黑名单**：
```
com.android.systemui          # 系统UI（状态栏、导航栏）
com.android.launcher*         # 桌面
com.google.android.gms        # Google服务弹窗
com.android.packageinstaller  # 安装器
com.android.permissioncontroller  # 权限弹窗
com.miui.*                    # 小米系统应用
com.huawei.*                  # 华为系统应用
com.oppo.*                    # OPPO系统应用
com.vivo.*                    # vivo系统应用
com.coloros.*                 # ColorOS系统应用
com.oneplus.*                 # OnePlus系统应用
```

### 2.3 操作后恢复（PostRecovery）

**触发时机**：每次操作执行后 500ms

**恢复流程**：
1. 检测当前前台应用包名
2. 对比目标包名，如果相同则无需恢复
3. 尝试恢复（最多3次）：
   - 第一次：按返回键
   - 第二次：再按返回键
   - 第三次：强制启动目标 Activity
4. 全部失败则记录异常，跳过后续操作

---

## 三、代码修改清单

### 3.1 修改文件列表

| 序号 | 文件 | 修改内容 | 优先级 |
|------|------|---------|--------|
| 1 | `internal/adb/client.go` | 添加 `GetForegroundPackage()` 获取前台应用包名 | P0 |
| 2 | `internal/ai/ui_parser.go` | 添加 `FindElementByCoords()` 根据坐标查找元素 | P0 |
| 3 | `internal/ai/interaction_engine.go` | 添加 `PreCheck()` 操作前检查 | P0 |
| 4 | `internal/ai/interaction_engine.go` | 添加 `PostRecovery()` 操作后恢复 | P0 |
| 5 | `internal/ai/interaction_engine.go` | 修改 `ExecuteAction()` 集成检查和恢复逻辑 | P0 |
| 6 | `internal/worker/orchestrator.go` | 确保目标包名传递到 AI 引擎 | P1 |

### 3.2 详细修改内容

#### 3.2.1 `internal/adb/client.go`

新增函数：
```go
// GetForegroundPackage 获取当前前台应用的包名
func (c *ADBClient) GetForegroundPackage() (string, error)
```

实现方式：
```bash
adb shell dumpsys window | grep mCurrentFocus
# 或
adb shell dumpsys activity activities | grep mResumedActivity
```

#### 3.2.2 `internal/ai/ui_parser.go`

新增函数：
```go
// FindElementByCoords 根据坐标查找对应的UI元素
func FindElementByCoords(xmlContent string, x, y int) (*UIElement, error)

// IsElementSafe 检查元素是否安全（属于目标应用）
func IsElementSafe(element *UIElement, targetPackage string) bool
```

#### 3.2.3 `internal/ai/interaction_engine.go`

新增函数：
```go
// PreCheckAction 操作前检查
// 返回 true 表示允许执行，false 表示应跳过
func (e *InteractionEngine) PreCheckAction(action *AIAction, uiXML string, targetPackage string) (bool, string)

// PostRecoveryCheck 操作后恢复检查
// 如果应用退出，尝试恢复到目标应用
func (e *InteractionEngine) PostRecoveryCheck(targetPackage string, targetActivity string) error
```

修改函数：
```go
// ExecuteAction 执行单个操作（修改）
func (e *InteractionEngine) ExecuteAction(action *AIAction, ...) error {
    // 1. 操作前检查
    if !e.PreCheckAction(action, uiXML, targetPackage) {
        return nil // 跳过危险操作
    }

    // 2. 执行操作（原有逻辑）
    ...

    // 3. 操作后恢复检查
    if err := e.PostRecoveryCheck(targetPackage, targetActivity); err != nil {
        return err
    }

    return nil
}
```

---

## 四、预期效果

| 指标 | 修改前 | 修改后 |
|------|--------|--------|
| Activity 分析成功率 | ~70% | ~95% |
| 误操作导致的应用退出 | 频繁 | 极少 |
| 数据污染（错误应用的流量） | 存在 | 基本消除 |
| 单个 Activity 分析耗时 | 正常 | +10%（检查开销） |
| 异常恢复能力 | 无 | 自动恢复 |

---

## 五、测试计划

1. **单元测试**：
   - `FindElementByCoords` 坐标查找准确性
   - `IsElementSafe` 包名判断正确性
   - `GetForegroundPackage` 包名解析正确性

2. **集成测试**：
   - 模拟点击系统导航栏，验证被拦截
   - 模拟点击广告跳转，验证自动恢复
   - 正常操作不受影响

3. **实际 APK 测试**：
   - 选择包含广告的应用测试
   - 验证 Activity 分析完整性

---

## 六、风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| UI dump 耗时增加 | 分析变慢 | 复用已有的 UI dump，避免重复获取 |
| 误判安全操作 | 漏掉有效点击 | 白名单机制 + 日志记录 |
| 恢复失败 | Activity 分析中断 | 标记为不稳定，继续下一个 |

---

## 七、实施步骤

- [x] 1. 在 `adb/client.go` 添加 `GetForegroundPackage()` 函数 ✅
- [x] 2. 在 `ai/ui_parser.go` 添加 `FindElementByCoords()` 函数 ✅
- [x] 3. 在 `ai/ui_parser.go` 添加 `IsElementSafe()` 函数 ✅
- [x] 4. 在 `ai/interaction_engine.go` 添加 `PreCheckAction()` 函数 ✅
- [x] 5. 在 `ai/interaction_engine.go` 添加 `PostRecoveryCheck()` 函数 ✅
- [x] 6. 修改 `ai/interaction_engine.go` 添加 `ExecuteActionSafe()` 集成新逻辑 ✅
- [x] 7. 修改 `worker/orchestrator.go` 使用 `ExecuteActionSafe()` ✅
- [x] 8. 编译测试 ✅
- [ ] 9. 实际 APK 验证（待测试）

---

**文档维护者**：APK Analysis Team
**最后更新**：2025-11-27
