package ai

import (
	"context"
	"encoding/json"
	"fmt"
	"regexp"
	"strings"
	"time"

	"github.com/sirupsen/logrus"
)

// InteractionEngine AIé©±åŠ¨çš„äº¤äº’å¼•æ“
type InteractionEngine struct {
	client *Client
	logger *logrus.Logger
}

// NewInteractionEngine åˆ›å»ºäº¤äº’å¼•æ“
func NewInteractionEngine(apiKey string, logger *logrus.Logger) *InteractionEngine {
	return &InteractionEngine{
		client: NewClient(apiKey, logger),
		logger: logger,
	}
}

// Action äº¤äº’åŠ¨ä½œ
type Action struct {
	Type     string `json:"type"`     // click, input, scroll
	X        int    `json:"x,omitempty"`
	Y        int    `json:"y,omitempty"`
	Value    string `json:"value,omitempty"`    // inputç±»å‹çš„è¾“å…¥å€¼
	Direction string `json:"direction,omitempty"` // scrollæ–¹å‘: up/down
	Reason   string `json:"reason"`
	Priority int    `json:"priority"` // 1-16, æ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆ
}

// PlanActions åˆ†æUIå¹¶ç”Ÿæˆäº¤äº’ç­–ç•¥
func (e *InteractionEngine) PlanActions(ctx context.Context, uiData *UIData, activityName string, appCategory string) ([]Action, error) {
	// æ£€æŸ¥æ˜¯å¦æœ‰å¯äº¤äº’å…ƒç´ 
	if len(uiData.ClickableElements) == 0 && len(uiData.InputFields) == 0 {
		e.logger.Info("No interactive elements found")
		return []Action{}, nil
	}

	// æ„å»ºPrompt
	prompt := e.buildAnalysisPrompt(uiData, activityName, appCategory)

	// è°ƒç”¨AIåˆ†æ (ä½¿ç”¨çº¯æ–‡æœ¬æ¨¡å¼,ä¸ä½¿ç”¨æˆªå›¾)
	aiResponse, err := e.callAI(ctx, prompt)
	if err != nil {
		e.logger.WithError(err).Warn("AI call failed, using fallback strategy")
		return e.fallbackStrategy(uiData, activityName), nil
	}

	// è§£æAIå“åº”
	actions := e.parseAIResponse(aiResponse, uiData)
	if len(actions) == 0 {
		e.logger.Warn("No actions generated by AI, using fallback")
		return e.fallbackStrategy(uiData, activityName), nil
	}

	// åŠ¨æ€é™åˆ¶æ“ä½œæ•°
	maxActions := CalculateMaxActions(uiData)
	if len(actions) > maxActions {
		actions = actions[:maxActions]
	}

	return actions, nil
}

// buildAnalysisPrompt æ„å»ºAIåˆ†ææç¤ºè¯
func (e *InteractionEngine) buildAnalysisPrompt(uiData *UIData, activityName string, appCategory string) string {
	// åˆ¤æ–­æ˜¯å¦æ˜¯ä¸»Activity
	isMainActivity := strings.Contains(strings.ToLower(activityName), "main") ||
		strings.Contains(strings.ToLower(activityName), "launcher") ||
		strings.Contains(strings.ToLower(activityName), "splash") ||
		strings.Contains(strings.ToLower(activityName), "welcome")

	// ç®€åŒ–å¯ç‚¹å‡»å…ƒç´ ä¿¡æ¯
	clickableSummary := []string{}
	for i, elem := range uiData.ClickableElements {
		if i >= 15 { // æœ€å¤š15ä¸ª
			break
		}

		displayText := elem.Label
		if displayText == "" {
			displayText = elem.Text
		}

		resourceIDShort := ""
		if elem.ResourceID != "" {
			parts := strings.Split(elem.ResourceID, "/")
			if len(parts) > 0 {
				resourceIDShort = parts[len(parts)-1]
			}
		}

		classShort := ""
		if elem.Class != "" {
			parts := strings.Split(elem.Class, ".")
			if len(parts) > 0 {
				classShort = parts[len(parts)-1]
			}
		}

		summary := fmt.Sprintf("%d. ", i+1)
		if displayText != "" {
			summary += fmt.Sprintf("æ–‡æœ¬:\"%s\" ", displayText)
		}
		if resourceIDShort != "" {
			summary += fmt.Sprintf("ID:%s ", resourceIDShort)
		}
		summary += fmt.Sprintf("ç±»å‹:%s åæ ‡:(%d,%d)", classShort, elem.Center[0], elem.Center[1])

		clickableSummary = append(clickableSummary, summary)
	}

	// è¾“å…¥æ¡†ä¿¡æ¯
	inputSummary := []string{}
	for i, elem := range uiData.InputFields {
		if i >= 5 { // æœ€å¤š5ä¸ª
			break
		}

		summary := fmt.Sprintf("%d. ", i+1)
		if elem.Text != "" {
			summary += fmt.Sprintf("é»˜è®¤æ–‡æœ¬:\"%s\" ", elem.Text)
		}
		if elem.ResourceID != "" {
			parts := strings.Split(elem.ResourceID, "/")
			if len(parts) > 0 {
				summary += fmt.Sprintf("ID:%s ", parts[len(parts)-1])
			}
		}
		summary += fmt.Sprintf("åæ ‡:(%d,%d)", elem.Center[0], elem.Center[1])

		inputSummary = append(inputSummary, summary)
	}

	// æ£€æµ‹ç‰¹æ®ŠæŒ‰é’®
	hasSkipLogin := false
	hasLoginButton := false
	hasBrowsableContent := len(uiData.ClickableElements) > 5 || len(uiData.ScrollableViews) > 0

	skipKeywords := []string{"skip", "later", "è·³è¿‡", "ç¨å", "æ¸¸å®¢", "guest", "visitor", "è¯•ç”¨", "trial", "try", "ä½“éªŒ", "experience"}
	loginKeywords := []string{"login", "signin", "ç™»å½•", "ç™»é™†"}

	for _, elem := range uiData.ClickableElements {
		combined := strings.ToLower(elem.Text + " " + elem.ResourceID + " " + elem.Label)

		for _, kw := range skipKeywords {
			if strings.Contains(combined, kw) {
				hasSkipLogin = true
				break
			}
		}

		for _, kw := range loginKeywords {
			if strings.Contains(combined, kw) {
				hasLoginButton = true
				break
			}
		}
	}

	// åŠ¨æ€è®¡ç®—å»ºè®®æ“ä½œæ•°
	suggestedActions := CalculateMaxActions(uiData)

	// æ„å»ºPrompt
	prompt := fmt.Sprintf(`ä½ æ˜¯ä¸€ä¸ªAndroidåº”ç”¨è‡ªåŠ¨åŒ–æµ‹è¯•ä¸“å®¶ã€‚å½“å‰æ­£åœ¨æµ‹è¯•ä¸€ä¸ªã€%sã€‘ç±»åº”ç”¨çš„ã€%sã€‘ç•Œé¢ã€‚

**ä»»åŠ¡ç›®æ ‡**: æ ¹æ®é¡µé¢å…ƒç´ ,è®¾è®¡%dä¸ªå·¦å³çš„äº¤äº’åŠ¨ä½œ(å¯ä»¥æ›´å¤šæˆ–æ›´å°‘,è§†å®é™…æƒ…å†µè€Œå®š),ä»¥è§¦å‘å°½å¯èƒ½å¤šçš„ç½‘ç»œè¯·æ±‚(ä¼˜å…ˆHTTP/HTTPS APIè°ƒç”¨)ã€‚

**é‡è¦æç¤º**:
- å¦‚æœå‘ç°"åŒæ„/å…è®¸/ç¡®å®š"ç­‰æƒé™æŒ‰é’®,**åªè¿”å›ç‚¹å‡»è¿™ä¸ªæŒ‰é’®çš„ä¸€ä¸ªåŠ¨ä½œå³å¯**,å› ä¸ºç‚¹å‡»åé¡µé¢ä¼šè·³è½¬
- é¿å…åœ¨åŒä¸€ä¸ªé¡µé¢ä¸Šè¿ç»­ç‚¹å‡»å¤šä¸ªäº’æ–¥æŒ‰é’®(å¦‚"åŒæ„"å’Œ"ä¸åŒæ„")
- ä¼˜å…ˆæ‰§è¡Œä¼šå¯¼è‡´é¡µé¢è·³è½¬çš„é«˜ä»·å€¼åŠ¨ä½œ

**å½“å‰ç•Œé¢åˆ†æ**:
- æ˜¯å¦æ˜¯ä¸»Activity: %t
- æ˜¯å¦æœ‰è·³è¿‡ç™»å½•é€‰é¡¹: %t
- æ˜¯å¦æœ‰ç™»å½•æŒ‰é’®: %t
- æ˜¯å¦æœ‰å¯æµè§ˆå†…å®¹: %t

**UIå¯äº¤äº’å…ƒç´ **:
%s

**è¾“å…¥æ¡†**:
%s

**äº¤äº’ç­–ç•¥è¦æ±‚**:
0. **ğŸ”¥ ç³»ç»Ÿ"Open"æŒ‰é’®(è¶…é«˜ä¼˜å…ˆçº§ - ä¼˜å…ˆçº§16)**:
   - **åœºæ™¯**: Androidç³»ç»Ÿè®¾ç½®çš„"App info"é¡µé¢
   - **å¿…é¡»æœ€ä¼˜å…ˆç‚¹å‡»**: Open/æ‰“å¼€/Launch/å¯åŠ¨
   - **ä½œç”¨**: ä»ç³»ç»Ÿè®¾ç½®é¡µé¢å¯åŠ¨åº”ç”¨è¿›å…¥åº”ç”¨å†…éƒ¨
   - **é‡è¦**: å¦‚æœç•Œé¢æœ‰"Open", "Uninstall", "Force stop"ä¸‰ä¸ªæŒ‰é’®,åªèƒ½ç‚¹å‡»"Open"!
1. **æƒé™åŒæ„ç­–ç•¥(æœ€é«˜ä¼˜å…ˆçº§ - ä¼˜å…ˆçº§15)**:
   - **å¿…é¡»ä¼˜å…ˆç‚¹å‡»**: åŒæ„/å…è®¸/ç¡®å®š/Accept/Allow/Agree/OK/æˆæƒ/Grant/ç»§ç»­/Continue
   - **è¿™äº›æŒ‰é’®é€šå¸¸åœ¨æƒé™å¼¹çª—/æœåŠ¡åè®®/éšç§æ”¿ç­–é¡µé¢å‡ºç°**
   - **ç¤ºä¾‹**: "åŒæ„å¹¶ç»§ç»­"(ä¼˜å…ˆçº§15) vs "ä¸åŒæ„"(ç¦æ­¢ç‚¹å‡»)
2. **ç™»å½•ç­–ç•¥(æ¬¡é«˜ä¼˜å…ˆçº§ - ä¼˜å…ˆçº§14)** - ç›®æ ‡æ˜¯åœ¨ä¸ç™»å½•æƒ…å†µä¸‹æµè§ˆAPP:
   - **ä¼˜å…ˆçº§14**: ç‚¹å‡»"è·³è¿‡ç™»å½•/ç¨å/æ¸¸å®¢æ¨¡å¼/è¯•ç”¨/ä½“éªŒ/å…è´¹è¯•ç”¨/å…ç™»å½•ä½“éªŒ/æš‚ä¸ç™»å½•/å…ˆé€›é€›"
   - **åªåœ¨ç‰¹æ®Šæƒ…å†µç‚¹å‡»ç™»å½•**: å½“å‰æ˜¯ä¸»Activityä¸”ç•Œé¢åªæœ‰ç™»å½•/æ³¨å†ŒæŒ‰é’®(æ— å…¶ä»–å¯ç‚¹å‡»å†…å®¹)ä¸”æ²¡æœ‰è·³è¿‡é€‰é¡¹
   - **å¦‚æœæœ‰å¯æµè§ˆå†…å®¹**: ä¼˜å…ˆæµè§ˆå†…å®¹,å®Œå…¨å¿½ç•¥ç™»å½•æŒ‰é’®
   - **æ³¨æ„åŒºåˆ†**: "ç™»å½•"(Login/Sign in) vs "é€€å‡ºç™»å½•"(Sign out/Logout) - åè€…ä¸è¦ç‚¹å‡»
3. ä¼˜å…ˆç‚¹å‡»é«˜ä»·å€¼æŒ‰é’®: æœç´¢/åˆ·æ–°/åˆ†äº«/å‘é€/æŸ¥çœ‹è¯¦æƒ…/æµè§ˆ/è¿›å…¥/æ›´å¤š (ä¼˜å…ˆçº§10-12)
4. **ğŸš« ç»å¯¹ç¦æ­¢ç‚¹å‡»(ä¼˜å…ˆçº§å¿…é¡»ä¸º0æˆ–ä¸è¿”å›)**:
   - **æ‹’ç»ç±»**: æ‹’ç»/ä¸åŒæ„/ç¦æ­¢/Deny/Refuse/Disagree/Decline
   - **å¦å®šç±»**: å¦/ä¸/No/Nope
   - **å–æ¶ˆç±»**: å–æ¶ˆ/Cancel
   - **é€€å‡ºç±»**: è¿”å›/å…³é—­/é€€å‡º/é€€å‡ºç™»å½•/back/exit/quit/sign out/logout/close
   - **é‡è¦**: å¦‚æœç•Œé¢åŒæ—¶æœ‰"åŒæ„"å’Œ"ä¸åŒæ„"æŒ‰é’®,åªèƒ½è¿”å›"åŒæ„"çš„ç‚¹å‡»åŠ¨ä½œ!
5. å¦‚æœç•Œé¢å¯æ»šåŠ¨,ä¼˜å…ˆæ»šåŠ¨æµè§ˆå†…å®¹ (ä¼˜å…ˆçº§8)
6. æ¯ä¸ªåŠ¨ä½œå¿…é¡»ä¿è¯ç”¨æˆ·åœç•™åœ¨APPå†…éƒ¨,ä¸èƒ½é€€å‡ºåˆ°æ¡Œé¢

**è¾“å‡ºæ ¼å¼** (ä¸¥æ ¼JSONæ•°ç»„):
` + "```json" + `
[
  {
    "type": "click",
    "x": 540,
    "y": 875,
    "reason": "ç‚¹å‡»ç™»å½•æŒ‰é’®,è§¦å‘è®¤è¯APIè¯·æ±‚",
    "priority": 10
  },
  {
    "type": "input",
    "x": 540,
    "y": 500,
    "value": "test@example.com",
    "reason": "å¡«å†™é‚®ç®±è¾“å…¥æ¡†",
    "priority": 9
  },
  {
    "type": "scroll",
    "direction": "down",
    "reason": "å‘ä¸‹æ»šåŠ¨åŠ è½½æ›´å¤šå†…å®¹",
    "priority": 5
  }
]
` + "```" + `

**æ³¨æ„**:
- åªè¿”å›JSONæ•°ç»„,ä¸è¦å…¶ä»–è§£é‡Š
- priorityèŒƒå›´1-16,æ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆ
- typeåªèƒ½æ˜¯: click / input / scroll
- åæ ‡å¿…é¡»åœ¨å±å¹•èŒƒå›´å†…(0-1080, 0-2340)`,
		appCategory,
		activityName,
		suggestedActions,
		isMainActivity,
		hasSkipLogin,
		hasLoginButton,
		hasBrowsableContent,
		formatList(clickableSummary),
		formatList(inputSummary),
	)

	return prompt
}

// formatList æ ¼å¼åŒ–åˆ—è¡¨
func formatList(items []string) string {
	if len(items) == 0 {
		return "(æ— )"
	}
	return strings.Join(items, "\n")
}

// callAI è°ƒç”¨AI API
func (e *InteractionEngine) callAI(ctx context.Context, prompt string) (string, error) {
	// ä½¿ç”¨ GLM-4.5-Flash æ¨¡å‹ï¼Œç¦ç”¨æ·±åº¦æ€è€ƒä»¥åŠ å¿«å“åº”
	reqBody := ChatRequest{
		Model:    "GLM-4.5-Flash",
		Thinking: &ThinkingConfig{Type: "disabled"},
		Messages: []Message{
			{
				Role: "user",
				Content: []ContentPart{
					{
						Type: "text",
						Text: prompt,
					},
				},
			},
		},
	}

	resp, err := e.client.sendChatRequest(ctx, reqBody)
	if err != nil {
		return "", err
	}

	if len(resp.Choices) == 0 {
		return "", fmt.Errorf("no response from AI")
	}

	return resp.Choices[0].Message.Content, nil
}

// parseAIResponse è§£æAIè¿”å›çš„JSONå“åº”
func (e *InteractionEngine) parseAIResponse(response string, uiData *UIData) []Action {
	// æå–JSON (å¯èƒ½è¢«```åŒ…è£¹ï¼Œæ”¯æŒå¤šè¡ŒJSON)
	// (?s) å¯ç”¨ DOTALL æ¨¡å¼ï¼Œè®© . åŒ¹é…æ¢è¡Œç¬¦
	re := regexp.MustCompile("(?s)```json\\s*(\\[.*?\\])\\s*```")
	matches := re.FindStringSubmatch(response)

	var jsonStr string
	if len(matches) > 1 {
		jsonStr = matches[1]
	} else {
		// å°è¯•ç›´æ¥è§£ææ•´ä¸ªå“åº”
		jsonStr = response
	}

	var actions []Action
	if err := json.Unmarshal([]byte(jsonStr), &actions); err != nil {
		e.logger.WithError(err).WithField("response", response[:min(len(response), 200)]).Warn("Failed to parse AI response")
		return []Action{}
	}

	// ç¦æ­¢å…³é”®è¯åˆ—è¡¨
	forbiddenKeywords := []string{
		"è¿”å›", "back", "å…³é—­", "close",
		"é€€å‡º", "exit", "quit",
		"æ‹’ç»", "deny", "refuse", "ä¸åŒæ„", "disagree", "decline",
		"ç¦æ­¢", "forbid", "å¦", "no", "nope", "å–æ¶ˆ", "cancel",
		"é€€å‡ºç™»å½•", "sign out", "logout",
	}

	// éªŒè¯å’Œè¿‡æ»¤
	validActions := []Action{}
	for _, action := range actions {
		// æ£€æŸ¥ç±»å‹
		if action.Type != "click" && action.Type != "input" && action.Type != "scroll" {
			continue
		}

		// æ£€æŸ¥reasonæ˜¯å¦åŒ…å«ç¦æ­¢å…³é”®è¯
		if action.Type == "click" {
			reason := strings.ToLower(action.Reason)
			isForbidden := false
			for _, kw := range forbiddenKeywords {
				if strings.Contains(reason, kw) {
					e.logger.WithField("reason", action.Reason).Info("Filtered forbidden action")
					isForbidden = true
					break
				}
			}
			if isForbidden {
				continue
			}
		}

		validActions = append(validActions, action)
	}

	// æŒ‰ä¼˜å…ˆçº§æ’åº (ä»é«˜åˆ°ä½)
	for i := 0; i < len(validActions); i++ {
		for j := i + 1; j < len(validActions); j++ {
			if validActions[j].Priority > validActions[i].Priority {
				validActions[i], validActions[j] = validActions[j], validActions[i]
			}
		}
	}

	return validActions
}

// fallbackStrategy é™çº§ç­–ç•¥: åŸºäºè§„åˆ™ç”Ÿæˆç®€å•äº¤äº’
func (e *InteractionEngine) fallbackStrategy(uiData *UIData, activityName string) []Action {
	actions := []Action{}

	// åˆ¤æ–­æ˜¯å¦æ˜¯ä¸»Activity
	isMainActivity := strings.Contains(strings.ToLower(activityName), "main") ||
		strings.Contains(strings.ToLower(activityName), "launcher") ||
		strings.Contains(strings.ToLower(activityName), "splash") ||
		strings.Contains(strings.ToLower(activityName), "welcome")

	// å…³é”®è¯åˆ—è¡¨
	openKeywords := []string{"open", "æ‰“å¼€", "launch", "å¯åŠ¨"}
	agreeKeywords := []string{"åŒæ„", "agree", "å…è®¸", "allow", "ç¡®å®š", "ok", "accept", "æˆæƒ", "grant", "ç»§ç»­", "continue"}
	skipLoginKeywords := []string{"skip", "later", "è·³è¿‡", "ç¨å", "æ¸¸å®¢", "guest", "visitor", "è¯•ç”¨", "trial", "try", "ä½“éªŒ", "experience"}
	loginKeywords := []string{"login", "signin", "ç™»å½•", "ç™»é™†", "register", "æ³¨å†Œ"}
	highPriorityKeywords := []string{"æœç´¢", "search", "åˆ·æ–°", "refresh", "åˆ†äº«", "share", "å‘é€", "send", "æŸ¥çœ‹", "view", "è¯¦æƒ…", "detail", "æ›´å¤š", "more"}
	forbiddenKeywords := []string{"è¿”å›", "back", "å…³é—­", "close", "é€€å‡º", "exit", "quit", "æ‹’ç»", "deny", "refuse", "ä¸åŒæ„", "disagree", "ç¦æ­¢", "forbid", "å¦", "no", "å–æ¶ˆ", "cancel"}

	// æ£€æŸ¥æ˜¯å¦æœ‰è·³è¿‡ç™»å½•é€‰é¡¹å’Œå¯æµè§ˆå†…å®¹
	hasSkipOption := false
	hasLoginOnly := true
	hasBrowsableContent := len(uiData.ClickableElements) > 5

	for _, elem := range uiData.ClickableElements {
		combined := strings.ToLower(elem.Label + " " + elem.Text + " " + elem.ResourceID)

		// æ£€æµ‹è·³è¿‡ç™»å½•é€‰é¡¹
		for _, kw := range skipLoginKeywords {
			if strings.Contains(combined, kw) {
				hasSkipOption = true
				break
			}
		}

		// å¦‚æœæœ‰éç™»å½•æŒ‰é’®ï¼Œè¯´æ˜ä¸æ˜¯çº¯ç™»å½•é¡µ
		isLogin := false
		for _, kw := range loginKeywords {
			if strings.Contains(combined, kw) {
				isLogin = true
				break
			}
		}
		isSkip := false
		for _, kw := range skipLoginKeywords {
			if strings.Contains(combined, kw) {
				isSkip = true
				break
			}
		}

		if !isLogin && !isSkip && (elem.Text != "" || strings.Contains(elem.ResourceID, "btn") || strings.Contains(elem.ResourceID, "item")) {
			hasLoginOnly = false
		}
	}

	// å¤„ç†å¯ç‚¹å‡»å…ƒç´ 
	for _, elem := range uiData.ClickableElements {
		if len(actions) >= 5 { // é™çº§ç­–ç•¥æœ€å¤š5ä¸ªåŠ¨ä½œ
			break
		}

		combined := strings.ToLower(elem.Label + " " + elem.Text + " " + elem.ResourceID)

		// æ£€æŸ¥æ˜¯å¦ç¦æ­¢
		isForbidden := false
		for _, kw := range forbiddenKeywords {
			if strings.Contains(combined, kw) {
				isForbidden = true
				break
			}
		}
		if isForbidden {
			continue
		}

		// åˆ¤æ–­ä¼˜å…ˆçº§
		score := 5

		// OpenæŒ‰é’®
		isOpen := false
		for _, kw := range openKeywords {
			if strings.Contains(combined, kw) {
				isOpen = true
				score = 16
				break
			}
		}

		// æƒé™åŒæ„
		isAgree := false
		if !isOpen {
			for _, kw := range agreeKeywords {
				if strings.Contains(combined, kw) {
					isAgree = true
					score = 15
					break
				}
			}
		}

		// è·³è¿‡ç™»å½•
		isSkipLogin := false
		if !isOpen && !isAgree {
			for _, kw := range skipLoginKeywords {
				if strings.Contains(combined, kw) {
					isSkipLogin = true
					score = 14
					break
				}
			}
		}

		// ç™»å½•æŒ‰é’® - é™ä½ä¼˜å…ˆçº§ï¼Œå°½é‡é¿å…ç‚¹å‡»
		isLogin := false
		if !isOpen && !isAgree && !isSkipLogin {
			for _, kw := range loginKeywords {
				if strings.Contains(combined, kw) {
					isLogin = true
					// åªåœ¨ç‰¹å®šæƒ…å†µä¸‹ç‚¹å‡»ç™»å½•ï¼Œä¸”ä¼˜å…ˆçº§å¾ˆä½
					if isMainActivity && hasLoginOnly && !hasSkipOption {
						score = 3 // é™ä½ä¼˜å…ˆçº§ä»8åˆ°3
					} else {
						continue // è·³è¿‡ç™»å½•æŒ‰é’®
					}
					break
				}
			}
		}

		// é«˜ä»·å€¼æŒ‰é’®
		if !isOpen && !isAgree && !isSkipLogin && !isLogin {
			for _, kw := range highPriorityKeywords {
				if strings.Contains(combined, kw) {
					score = 10
					break
				}
			}
		}

		// æ„å»ºæè¿°æ–‡æœ¬
		descText := elem.Label
		if descText == "" {
			descText = elem.Text
		}
		if descText == "" {
			parts := strings.Split(elem.ResourceID, "/")
			if len(parts) > 0 {
				descText = parts[len(parts)-1]
			}
		}
		if descText == "" {
			descText = "(æ— æ–‡æœ¬)"
		}

		actions = append(actions, Action{
			Type:     "click",
			X:        elem.Center[0],
			Y:        elem.Center[1],
			Reason:   fmt.Sprintf("ç‚¹å‡»æŒ‰é’®: %s", descText),
			Priority: score,
		})
	}

	// å¦‚æœæœ‰å¯æµè§ˆå†…å®¹ï¼Œæ·»åŠ æ»šåŠ¨æ“ä½œ
	if hasBrowsableContent && len(uiData.ScrollableViews) > 0 {
		actions = append(actions, Action{
			Type:      "scroll",
			Direction: "down",
			Reason:    "å‘ä¸‹æ»šåŠ¨æµè§ˆæ›´å¤šå†…å®¹",
			Priority:  12,
		})
	}

	// æ’åº
	for i := 0; i < len(actions); i++ {
		for j := i + 1; j < len(actions); j++ {
			if actions[j].Priority > actions[i].Priority {
				actions[i], actions[j] = actions[j], actions[i]
			}
		}
	}

	return actions
}

// ExecuteAction æ‰§è¡Œå•ä¸ªåŠ¨ä½œ (éœ€è¦ADBå®¢æˆ·ç«¯é…åˆ)
type ActionExecutor interface {
	TapScreen(ctx context.Context, x, y int) error
	InputText(ctx context.Context, text string) error
	Shell(ctx context.Context, command string) (string, error)
	GetForegroundPackage(ctx context.Context) (string, error)
	StartActivity(ctx context.Context, component string) error
	PressBack(ctx context.Context) error
}

// ExecuteAction æ‰§è¡ŒåŠ¨ä½œ
func (e *InteractionEngine) ExecuteAction(ctx context.Context, action Action, executor ActionExecutor) error {
	e.logger.WithFields(logrus.Fields{
		"type":     action.Type,
		"reason":   action.Reason,
		"priority": action.Priority,
	}).Info("Executing action")

	switch action.Type {
	case "click":
		return executor.TapScreen(ctx, action.X, action.Y)

	case "input":
		// å…ˆç‚¹å‡»è¾“å…¥æ¡†èšç„¦
		if err := executor.TapScreen(ctx, action.X, action.Y); err != nil {
			return err
		}
		time.Sleep(500 * time.Millisecond)
		// è¾“å…¥æ–‡æœ¬
		return executor.InputText(ctx, action.Value)

	case "scroll":
		// æ»šåŠ¨æ“ä½œ
		var cmd string
		if action.Direction == "down" {
			cmd = "input swipe 540 1500 540 500 300"
		} else {
			cmd = "input swipe 540 500 540 1500 300"
		}
		_, err := executor.Shell(ctx, cmd)
		return err

	default:
		return fmt.Errorf("unknown action type: %s", action.Type)
	}
}

// min è¿”å›æœ€å°å€¼
func min(a, b int) int {
	if a < b {
		return a
	}
	return b
}

// ========== æ“ä½œå®‰å…¨æ£€æŸ¥ç›¸å…³å‡½æ•° ==========

// PreCheckResult æ“ä½œå‰æ£€æŸ¥ç»“æœ
type PreCheckResult struct {
	Safe       bool   // æ˜¯å¦å®‰å…¨å¯æ‰§è¡Œ
	Reason     string // æ‹’ç»åŸå› ï¼ˆå¦‚æœä¸å®‰å…¨ï¼‰
	Element    *UIElement // æ‰¾åˆ°çš„ç›®æ ‡å…ƒç´ ï¼ˆå¯èƒ½ä¸ºnilï¼‰
}

// PreCheckAction æ“ä½œå‰æ£€æŸ¥
// æ£€æŸ¥ç›®æ ‡åæ ‡çš„å…ƒç´ æ˜¯å¦å±äºç›®æ ‡åº”ç”¨ï¼Œé¿å…è¯¯ç‚¹å‡»ç³»ç»ŸUIæˆ–å…¶ä»–åº”ç”¨
func (e *InteractionEngine) PreCheckAction(action Action, uiXML string, targetPackage string, screenWidth, screenHeight int) PreCheckResult {
	// åªæ£€æŸ¥ç‚¹å‡»æ“ä½œ
	if action.Type != "click" {
		return PreCheckResult{Safe: true, Reason: "éç‚¹å‡»æ“ä½œï¼Œè·³è¿‡æ£€æŸ¥"}
	}

	// 1. é¦–å…ˆæ£€æŸ¥åæ ‡æ˜¯å¦åœ¨å±é™©åŒºåŸŸ
	if IsDangerousZone(action.X, action.Y, screenWidth, screenHeight) {
		return PreCheckResult{
			Safe:   false,
			Reason: fmt.Sprintf("åæ ‡(%d,%d)ä½äºå±é™©åŒºåŸŸï¼ˆçŠ¶æ€æ /å¯¼èˆªæ /è¾¹ç¼˜ï¼‰", action.X, action.Y),
		}
	}

	// 2. å¦‚æœæœ‰ UI XMLï¼ŒæŸ¥æ‰¾ç›®æ ‡å…ƒç´ å¹¶æ£€æŸ¥åŒ…å
	if uiXML != "" {
		element, err := FindElementByCoords(uiXML, action.X, action.Y)
		if err != nil {
			// æ‰¾ä¸åˆ°å…ƒç´ ï¼Œå¯èƒ½æ˜¯åæ ‡è¶…å‡ºUIèŒƒå›´
			e.logger.WithError(err).WithFields(logrus.Fields{
				"x": action.X,
				"y": action.Y,
			}).Debug("æ— æ³•æ‰¾åˆ°åæ ‡å¯¹åº”çš„å…ƒç´ ")
			// æ‰¾ä¸åˆ°å…ƒç´ æ—¶ä¸é˜»æ­¢æ“ä½œï¼Œå¯èƒ½æ˜¯åŠ¨æ€å†…å®¹
			return PreCheckResult{Safe: true, Reason: "æœªæ‰¾åˆ°å…ƒç´ ï¼Œå…è®¸æ“ä½œ", Element: nil}
		}

		// 3. æ£€æŸ¥å…ƒç´ æ˜¯å¦å®‰å…¨
		if !IsElementSafe(element, targetPackage) {
			return PreCheckResult{
				Safe:    false,
				Reason:  fmt.Sprintf("å…ƒç´ å±äºå…¶ä»–åº”ç”¨(%s)ï¼Œå¯èƒ½å¯¼è‡´é€€å‡º", element.Package),
				Element: element,
			}
		}

		return PreCheckResult{
			Safe:    true,
			Reason:  "å…ƒç´ å®‰å…¨",
			Element: element,
		}
	}

	// æ²¡æœ‰ UI XML æ•°æ®ï¼Œé»˜è®¤å…è®¸
	return PreCheckResult{Safe: true, Reason: "æ— UIæ•°æ®ï¼Œå…è®¸æ“ä½œ"}
}

// PostRecoveryCheck æ“ä½œåæ¢å¤æ£€æŸ¥
// æ£€æŸ¥å½“å‰å‰å°åº”ç”¨æ˜¯å¦ä»æ˜¯ç›®æ ‡åº”ç”¨ï¼Œå¦‚æœä¸æ˜¯åˆ™å°è¯•æ¢å¤
func (e *InteractionEngine) PostRecoveryCheck(ctx context.Context, executor ActionExecutor, targetPackage string, targetActivity string) error {
	// ç­‰å¾…æ“ä½œå®Œæˆå’Œé¡µé¢ç¨³å®š
	time.Sleep(500 * time.Millisecond)

	// æ£€æŸ¥å½“å‰å‰å°åº”ç”¨
	currentPackage, err := executor.GetForegroundPackage(ctx)
	if err != nil {
		e.logger.WithError(err).Warn("æ— æ³•è·å–å‰å°åº”ç”¨åŒ…å")
		// è·å–å¤±è´¥ä¸é˜»å¡æµç¨‹
		return nil
	}

	// å¦‚æœä»åœ¨ç›®æ ‡åº”ç”¨ä¸­ï¼Œæ— éœ€æ¢å¤
	if currentPackage == targetPackage {
		return nil
	}

	e.logger.WithFields(logrus.Fields{
		"current_package": currentPackage,
		"target_package":  targetPackage,
	}).Warn("åº”ç”¨å·²é€€å‡ºåˆ°å…¶ä»–åº”ç”¨ï¼Œå°è¯•æ¢å¤")

	// å°è¯•æ¢å¤ï¼ˆæœ€å¤š3æ¬¡ï¼‰
	for attempt := 1; attempt <= 3; attempt++ {
		var recoverErr error

		switch attempt {
		case 1:
			// ç¬¬ä¸€æ¬¡ï¼šæŒ‰è¿”å›é”®
			e.logger.Info("æ¢å¤å°è¯•1: æŒ‰è¿”å›é”®")
			recoverErr = executor.PressBack(ctx)

		case 2:
			// ç¬¬äºŒæ¬¡ï¼šå†æŒ‰è¿”å›é”®
			e.logger.Info("æ¢å¤å°è¯•2: å†æ¬¡æŒ‰è¿”å›é”®")
			recoverErr = executor.PressBack(ctx)

		case 3:
			// ç¬¬ä¸‰æ¬¡ï¼šå¼ºåˆ¶å¯åŠ¨ç›®æ ‡ Activity
			e.logger.Info("æ¢å¤å°è¯•3: å¼ºåˆ¶å¯åŠ¨ç›®æ ‡Activity")
			if targetActivity != "" {
				recoverErr = executor.StartActivity(ctx, targetActivity)
			} else {
				// å¦‚æœæ²¡æœ‰æŒ‡å®š Activityï¼Œå°è¯•é€šè¿‡ monkey å¯åŠ¨ä¸» Activity
				_, recoverErr = executor.Shell(ctx, fmt.Sprintf("monkey -p %s -c android.intent.category.LAUNCHER 1", targetPackage))
			}
		}

		if recoverErr != nil {
			e.logger.WithError(recoverErr).WithField("attempt", attempt).Warn("æ¢å¤æ“ä½œæ‰§è¡Œå¤±è´¥")
			continue
		}

		// ç­‰å¾…æ¢å¤å®Œæˆ
		time.Sleep(1 * time.Second)

		// å†æ¬¡æ£€æŸ¥å‰å°åº”ç”¨
		currentPackage, err = executor.GetForegroundPackage(ctx)
		if err != nil {
			continue
		}

		if currentPackage == targetPackage {
			e.logger.WithField("attempt", attempt).Info("åº”ç”¨æ¢å¤æˆåŠŸ")
			return nil
		}
	}

	// æ¢å¤å¤±è´¥
	return fmt.Errorf("åº”ç”¨æ¢å¤å¤±è´¥ï¼šå½“å‰å‰å°åº”ç”¨ä¸º %sï¼Œç›®æ ‡åº”ç”¨ä¸º %s", currentPackage, targetPackage)
}

// ExecuteActionSafe å®‰å…¨æ‰§è¡ŒåŠ¨ä½œï¼ˆå¸¦å‰ç½®æ£€æŸ¥å’Œåç½®æ¢å¤ï¼‰
// è¿™æ˜¯ ExecuteAction çš„å¢å¼ºç‰ˆæœ¬ï¼Œé›†æˆäº†å®‰å…¨æ£€æŸ¥æœºåˆ¶
func (e *InteractionEngine) ExecuteActionSafe(ctx context.Context, action Action, executor ActionExecutor, targetPackage string, targetActivity string, uiXML string, screenWidth, screenHeight int) error {
	// 1. æ“ä½œå‰æ£€æŸ¥
	preCheck := e.PreCheckAction(action, uiXML, targetPackage, screenWidth, screenHeight)
	if !preCheck.Safe {
		e.logger.WithFields(logrus.Fields{
			"action_type": action.Type,
			"reason":      action.Reason,
			"reject_reason": preCheck.Reason,
			"x":           action.X,
			"y":           action.Y,
		}).Warn("æ“ä½œè¢«å®‰å…¨æ£€æŸ¥æ‹¦æˆªï¼Œè·³è¿‡æ­¤æ“ä½œ")
		return nil // è¿”å›nilï¼Œä¸ä¸­æ–­åç»­æ“ä½œ
	}

	// è®°å½•é€šè¿‡æ£€æŸ¥çš„æ—¥å¿—
	if preCheck.Element != nil {
		e.logger.WithFields(logrus.Fields{
			"action_type":     action.Type,
			"element_package": preCheck.Element.Package,
			"element_text":    preCheck.Element.Text,
		}).Debug("æ“ä½œé€šè¿‡å®‰å…¨æ£€æŸ¥")
	}

	// 2. æ‰§è¡Œæ“ä½œ
	err := e.ExecuteAction(ctx, action, executor)
	if err != nil {
		return err
	}

	// 3. æ“ä½œåæ¢å¤æ£€æŸ¥ï¼ˆä»…å¯¹ç‚¹å‡»æ“ä½œï¼‰
	if action.Type == "click" {
		if recoveryErr := e.PostRecoveryCheck(ctx, executor, targetPackage, targetActivity); recoveryErr != nil {
			e.logger.WithError(recoveryErr).Warn("åº”ç”¨æ¢å¤å¤±è´¥ï¼Œå¯èƒ½å½±å“åç»­åˆ†æ")
			// ä¸è¿”å›é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œåç»­æ“ä½œ
		}
	}

	return nil
}
