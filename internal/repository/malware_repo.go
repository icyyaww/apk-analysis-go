package repository

import (
	"context"

	"github.com/apk-analysis/apk-analysis-go/internal/malware"
	"github.com/sirupsen/logrus"
	"gorm.io/gorm"
	"gorm.io/gorm/clause"
)

// MalwareRepository 恶意检测结果 Repository
type MalwareRepository interface {
	Create(ctx context.Context, result *malware.TaskMalwareResult) error
	Update(ctx context.Context, result *malware.TaskMalwareResult) error
	Upsert(ctx context.Context, result *malware.TaskMalwareResult) error
	GetByTaskID(ctx context.Context, taskID string) (*malware.TaskMalwareResult, error)
	Delete(ctx context.Context, taskID string) error
	GetStatistics(ctx context.Context) (*malware.MalwareStatistics, error)
	GetRecentMalware(ctx context.Context, limit int) ([]*malware.TaskMalwareResult, error)
}

// malwareRepo 恶意检测结果 Repository 实现
type malwareRepo struct {
	db     *gorm.DB
	logger *logrus.Logger
}

// NewMalwareRepository 创建恶意检测结果 Repository
func NewMalwareRepository(db *gorm.DB, logger *logrus.Logger) MalwareRepository {
	return &malwareRepo{
		db:     db,
		logger: logger,
	}
}

// Create 创建恶意检测结果
func (r *malwareRepo) Create(ctx context.Context, result *malware.TaskMalwareResult) error {
	return r.db.WithContext(ctx).Create(result).Error
}

// Update 更新恶意检测结果
func (r *malwareRepo) Update(ctx context.Context, result *malware.TaskMalwareResult) error {
	return r.db.WithContext(ctx).Save(result).Error
}

// Upsert 插入或更新恶意检测结果
func (r *malwareRepo) Upsert(ctx context.Context, result *malware.TaskMalwareResult) error {
	return r.db.WithContext(ctx).
		Clauses(clause.OnConflict{
			Columns: []clause.Column{{Name: "task_id"}},
			DoUpdates: clause.AssignmentColumns([]string{
				"status",
				"is_malware", "confidence", "malware_probability", "benign_probability",
				"predicted_family", "family_probabilities",
				"models_used",
				"drebin_result", "mh100_k_result", "cic_mal_droid_result",
				"ensemble_result",
				"feature_summary", "feature_source",
				"extraction_time_ms", "inference_time_ms", "total_time_ms",
				"error_message", "detected_at",
			}),
		}).
		Create(result).Error
}

// GetByTaskID 根据任务 ID 查询恶意检测结果
func (r *malwareRepo) GetByTaskID(ctx context.Context, taskID string) (*malware.TaskMalwareResult, error) {
	var result malware.TaskMalwareResult
	err := r.db.WithContext(ctx).Where("task_id = ?", taskID).First(&result).Error
	if err != nil {
		return nil, err
	}
	return &result, nil
}

// Delete 删除恶意检测结果
func (r *malwareRepo) Delete(ctx context.Context, taskID string) error {
	return r.db.WithContext(ctx).Where("task_id = ?", taskID).Delete(&malware.TaskMalwareResult{}).Error
}

// GetStatistics 获取恶意检测统计信息
func (r *malwareRepo) GetStatistics(ctx context.Context) (*malware.MalwareStatistics, error) {
	var stats malware.MalwareStatistics

	// 使用临时结构体来存储基础统计（避免 GORM 验证 slice 字段）
	type basicStats struct {
		TotalScanned     int64   `gorm:"column:total_scanned"`
		MalwareCount     int64   `gorm:"column:malware_count"`
		BenignCount      int64   `gorm:"column:benign_count"`
		AvgConfidence    float64 `gorm:"column:avg_confidence"`
		AvgDetectionTime float64 `gorm:"column:avg_detection_time"`
	}
	var basic basicStats

	// 总体统计
	err := r.db.WithContext(ctx).Model(&malware.TaskMalwareResult{}).
		Select(`
			COUNT(*) as total_scanned,
			SUM(CASE WHEN is_malware = true THEN 1 ELSE 0 END) as malware_count,
			SUM(CASE WHEN is_malware = false THEN 1 ELSE 0 END) as benign_count,
			AVG(confidence) as avg_confidence,
			AVG(total_time_ms) as avg_detection_time
		`).
		Where("status = ?", malware.DetectionStatusCompleted).
		Scan(&basic).Error
	if err != nil {
		return nil, err
	}

	// 复制到结果结构体
	stats.TotalScanned = basic.TotalScanned
	stats.MalwareCount = basic.MalwareCount
	stats.BenignCount = basic.BenignCount
	stats.AvgConfidence = basic.AvgConfidence
	stats.AvgDetectionTime = basic.AvgDetectionTime

	// 计算恶意率
	if stats.TotalScanned > 0 {
		stats.MalwareRate = float64(stats.MalwareCount) / float64(stats.TotalScanned) * 100
	}

	// 家族分布
	var familyBreakdown []malware.FamilyBreakdownItem
	err = r.db.WithContext(ctx).Model(&malware.TaskMalwareResult{}).
		Select(`
			predicted_family as family,
			COUNT(*) as count
		`).
		Where("status = ? AND is_malware = true AND predicted_family IS NOT NULL AND predicted_family != ''",
			malware.DetectionStatusCompleted).
		Group("predicted_family").
		Order("count DESC").
		Scan(&familyBreakdown).Error

	if err == nil && len(familyBreakdown) > 0 {
		// 计算百分比
		for i := range familyBreakdown {
			if stats.MalwareCount > 0 {
				familyBreakdown[i].Percentage = float64(familyBreakdown[i].Count) / float64(stats.MalwareCount) * 100
			}
		}
		stats.FamilyBreakdown = familyBreakdown
	}

	// 置信度分布
	var confDist malware.ConfidenceDistribution
	err = r.db.WithContext(ctx).Model(&malware.TaskMalwareResult{}).
		Select(`
			SUM(CASE WHEN confidence > 0.9 THEN 1 ELSE 0 END) as high_confidence,
			SUM(CASE WHEN confidence BETWEEN 0.7 AND 0.9 THEN 1 ELSE 0 END) as medium_confidence,
			SUM(CASE WHEN confidence < 0.7 THEN 1 ELSE 0 END) as low_confidence
		`).
		Where("status = ?", malware.DetectionStatusCompleted).
		Scan(&confDist).Error

	if err == nil {
		stats.ConfidenceDist = &confDist
	}

	return &stats, nil
}

// GetRecentMalware 获取最近检测到的恶意软件
func (r *malwareRepo) GetRecentMalware(ctx context.Context, limit int) ([]*malware.TaskMalwareResult, error) {
	var results []*malware.TaskMalwareResult

	err := r.db.WithContext(ctx).
		Model(&malware.TaskMalwareResult{}).
		Select("task_malware_results.*, apk_tasks.apk_name").
		Joins("LEFT JOIN apk_tasks ON apk_tasks.id = task_malware_results.task_id").
		Where("task_malware_results.status = ? AND task_malware_results.is_malware = true", malware.DetectionStatusCompleted).
		Order("task_malware_results.detected_at DESC").
		Limit(limit).
		Find(&results).Error

	if err != nil {
		return nil, err
	}

	return results, nil
}
