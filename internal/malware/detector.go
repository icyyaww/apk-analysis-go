package malware

import (
	"context"
	"encoding/json"
	"fmt"
	"os"
	"time"

	"github.com/sirupsen/logrus"
)

// Detector 恶意检测器
type Detector struct {
	client  *Client
	config  *DetectorConfig
	logger  *logrus.Logger
	enabled bool
}

// DetectorConfig 检测器配置
type DetectorConfig struct {
	// 服务配置
	ServerURL string        `yaml:"server_url"`
	Timeout   time.Duration `yaml:"timeout"`

	// 默认检测配置
	DefaultModels           []string `yaml:"models"`
	ExtractGraphFeatures    bool     `yaml:"extract_graph_features"`
	ExtractTemporalFeatures bool     `yaml:"extract_temporal_features"`
	UseEnsemble             bool     `yaml:"use_ensemble"`

	// 重试配置
	MaxRetries int           `yaml:"max_retries"`
	RetryDelay time.Duration `yaml:"retry_delay"`
}

// DefaultDetectorConfig 默认检测器配置
func DefaultDetectorConfig() *DetectorConfig {
	return &DetectorConfig{
		ServerURL:               "http://localhost:5000",
		Timeout:                 120 * time.Second,
		DefaultModels:           []string{"drebin"},
		ExtractGraphFeatures:    true,
		ExtractTemporalFeatures: false,
		UseEnsemble:             false,
		MaxRetries:              3,
		RetryDelay:              1 * time.Second,
	}
}

// NewDetector 创建恶意检测器
func NewDetector(cfg *DetectorConfig, logger *logrus.Logger) *Detector {
	if cfg == nil {
		cfg = DefaultDetectorConfig()
	}
	if logger == nil {
		logger = logrus.New()
	}

	clientCfg := &ClientConfig{
		ServerURL: cfg.ServerURL,
		Timeout:   cfg.Timeout,
	}

	return &Detector{
		client:  NewClient(clientCfg, logger),
		config:  cfg,
		logger:  logger,
		enabled: true,
	}
}

// SetEnabled 设置是否启用
func (d *Detector) SetEnabled(enabled bool) {
	d.enabled = enabled
}

// IsEnabled 检查是否启用
func (d *Detector) IsEnabled() bool {
	return d.enabled
}

// CheckAvailability 检查服务可用性
func (d *Detector) CheckAvailability(ctx context.Context) error {
	if !d.enabled {
		return fmt.Errorf("malware detector is disabled")
	}

	health, err := d.client.Health(ctx)
	if err != nil {
		return fmt.Errorf("health check failed: %w", err)
	}

	if health.Status != "healthy" {
		return fmt.Errorf("service unhealthy: %s", health.Status)
	}

	if !health.ModelsLoaded {
		return fmt.Errorf("no models loaded")
	}

	d.logger.WithFields(logrus.Fields{
		"status":  health.Status,
		"models":  health.AvailableModels,
		"device":  health.Device,
	}).Info("Malware detection service available")

	return nil
}

// Detect 执行恶意检测
func (d *Detector) Detect(ctx context.Context, apkPath string, opts ...DetectOption) (*TaskMalwareResult, error) {
	if !d.enabled {
		return &TaskMalwareResult{
			Status:       DetectionStatusSkipped,
			ErrorMessage: "malware detection is disabled",
		}, nil
	}

	// 检查 APK 文件是否存在
	if _, err := os.Stat(apkPath); os.IsNotExist(err) {
		return nil, fmt.Errorf("APK file not found: %s", apkPath)
	}

	// 构建检测选项
	options := &detectOptions{
		models:           d.config.DefaultModels,
		graphFeatures:    d.config.ExtractGraphFeatures,
		temporalFeatures: d.config.ExtractTemporalFeatures,
		useEnsemble:      d.config.UseEnsemble,
	}
	for _, opt := range opts {
		opt(options)
	}

	// 构建请求
	request := &DetectionRequest{
		APKPath:         apkPath,
		UnpackedDexPath: options.unpackedDexPath,
		TaskID:          options.taskID,
		Models:          options.models,
		Options: DetectionOptions{
			ExtractGraphFeatures:    options.graphFeatures,
			ExtractTemporalFeatures: options.temporalFeatures,
			UseEnsemble:             options.useEnsemble,
		},
	}

	// 执行检测 (带重试)
	var response *DetectionResponse
	var lastErr error

	for i := 0; i <= d.config.MaxRetries; i++ {
		if i > 0 {
			d.logger.WithFields(logrus.Fields{
				"attempt": i + 1,
				"max":     d.config.MaxRetries + 1,
			}).Warn("Retrying malware detection")
			time.Sleep(d.config.RetryDelay)
		}

		response, lastErr = d.client.Detect(ctx, request)
		if lastErr == nil && response.Success {
			break
		}

		if response != nil && response.Error != "" {
			lastErr = fmt.Errorf(response.Error)
		}
	}

	// 构建结果
	result := &TaskMalwareResult{
		TaskID:    options.taskID,
		CreatedAt: time.Now(),
	}

	if lastErr != nil || response == nil || !response.Success {
		result.Status = DetectionStatusFailed
		if lastErr != nil {
			result.ErrorMessage = lastErr.Error()
		} else if response != nil {
			result.ErrorMessage = response.Error
		}
		return result, lastErr
	}

	// 解析检测结果
	d.parseDetectionResult(result, response.DetectionResults)

	return result, nil
}

// parseDetectionResult 解析检测结果到数据库模型
func (d *Detector) parseDetectionResult(result *TaskMalwareResult, detection *DetectionResult) {
	if detection == nil {
		return
	}

	now := time.Now()

	result.Status = DetectionStatusCompleted
	result.IsMalware = detection.IsMalware
	result.Confidence = detection.Confidence
	result.MalwareProbability = detection.MalwareProbability
	result.BenignProbability = detection.BenignProbability
	result.PredictedFamily = detection.PredictedFamily
	result.FeatureSource = detection.FeatureSource
	result.ExtractionTimeMs = detection.ExtractionTimeMs
	result.InferenceTimeMs = detection.InferenceTimeMs
	result.TotalTimeMs = detection.TotalTimeMs
	result.DetectedAt = &now

	// 序列化 JSON 字段
	if len(detection.FamilyProbabilities) > 0 {
		if data, err := json.Marshal(detection.FamilyProbabilities); err == nil {
			result.FamilyProbabilities = string(data)
		}
	}

	if detection.DrebinResult != nil {
		if data, err := json.Marshal(detection.DrebinResult); err == nil {
			result.DrebinResult = string(data)
		}
	}

	if detection.MH100KResult != nil {
		if data, err := json.Marshal(detection.MH100KResult); err == nil {
			result.MH100KResult = string(data)
		}
	}

	if detection.CICMalDroidResult != nil {
		if data, err := json.Marshal(detection.CICMalDroidResult); err == nil {
			result.CICMalDroidResult = string(data)
		}
	}

	if detection.EnsembleResult != nil {
		if data, err := json.Marshal(detection.EnsembleResult); err == nil {
			result.EnsembleResult = string(data)
		}
	}

	if detection.FeatureSummary != nil {
		if data, err := json.Marshal(detection.FeatureSummary); err == nil {
			result.FeatureSummary = string(data)
		}
	}

	// 设置使用的模型
	if len(detection.ModelsUsed) > 0 {
		if data, err := json.Marshal(detection.ModelsUsed); err == nil {
			result.ModelsUsed = string(data)
		}
	} else {
		// 根据结果推断使用的模型
		var models []string
		if detection.DrebinResult != nil {
			models = append(models, "drebin")
		}
		if detection.MH100KResult != nil {
			models = append(models, "mh100k")
		}
		if detection.CICMalDroidResult != nil {
			models = append(models, "cicmaldroid")
		}
		if len(models) > 0 {
			if data, err := json.Marshal(models); err == nil {
				result.ModelsUsed = string(data)
			}
		} else {
			result.ModelsUsed = "[]" // 空数组，避免空字符串导致 JSON 错误
		}
	}

	if len(detection.Errors) > 0 {
		result.ErrorMessage = detection.Errors[0]
	}
}

// detectOptions 检测选项
type detectOptions struct {
	taskID           string
	unpackedDexPath  string
	models           []string
	graphFeatures    bool
	temporalFeatures bool
	useEnsemble      bool
}

// DetectOption 检测选项函数
type DetectOption func(*detectOptions)

// WithTaskID 设置任务 ID
func WithTaskID(taskID string) DetectOption {
	return func(o *detectOptions) {
		o.taskID = taskID
	}
}

// WithUnpackedDex 设置脱壳后的 DEX 路径
func WithUnpackedDex(path string) DetectOption {
	return func(o *detectOptions) {
		o.unpackedDexPath = path
	}
}

// WithModels 设置使用的模型
func WithModels(models ...string) DetectOption {
	return func(o *detectOptions) {
		o.models = models
	}
}

// WithGraphFeatures 启用图特征提取
func WithGraphFeatures(enabled bool) DetectOption {
	return func(o *detectOptions) {
		o.graphFeatures = enabled
	}
}

// WithTemporalFeatures 启用时序特征提取
func WithTemporalFeatures(enabled bool) DetectOption {
	return func(o *detectOptions) {
		o.temporalFeatures = enabled
	}
}

// WithEnsemble 启用集成预测
func WithEnsemble(enabled bool) DetectOption {
	return func(o *detectOptions) {
		o.useEnsemble = enabled
	}
}
