# Nginx Canary Deployment Configuration
# 灰度发布配置 - 10% 流量切换到 Go 版本

upstream apk_analysis_python {
    # Python 版本后端 (90% 流量)
    server python-backend:5000 weight=90;
}

upstream apk_analysis_go {
    # Go 版本后端 (10% 流量)
    server go-backend:8080 weight=10;
}

# 流量分发策略
split_clients "${remote_addr}${http_user_agent}" $backend {
    10%     go;      # 10% 流量到 Go 版本
    *       python;  # 90% 流量到 Python 版本
}

server {
    listen 80;
    server_name apk-analysis.example.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name apk-analysis.example.com;

    # SSL 证书
    ssl_certificate /etc/letsencrypt/live/apk-analysis.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/apk-analysis.example.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    # 日志格式 - 记录后端版本
    log_format canary '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'backend=$backend upstream=$upstream_addr '
                      'response_time=$upstream_response_time';

    access_log /var/log/nginx/apk-analysis-canary-access.log canary;
    error_log /var/log/nginx/apk-analysis-canary-error.log;

    # 客户端上传限制
    client_max_body_size 100M;

    # 灰度发布路由
    location /api/ {
        # 根据 $backend 变量选择上游
        set $upstream_backend "";

        if ($backend = "go") {
            set $upstream_backend "apk_analysis_go";
        }

        if ($backend = "python") {
            set $upstream_backend "apk_analysis_python";
        }

        # 代理到选定的后端
        proxy_pass http://$upstream_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Backend-Version $backend;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # 添加响应头标识后端版本
        add_header X-Backend-Version $backend always;
    }

    # 强制路由到 Go 版本 (测试用)
    location /api/v2/ {
        rewrite ^/api/v2/(.*)$ /api/$1 break;
        proxy_pass http://apk_analysis_go;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header X-Backend-Version "go-forced" always;
    }

    # 强制路由到 Python 版本 (回退用)
    location /api/v1/ {
        rewrite ^/api/v1/(.*)$ /api/$1 break;
        proxy_pass http://apk_analysis_python;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header X-Backend-Version "python-forced" always;
    }

    # 健康检查端点
    location /health/go {
        proxy_pass http://apk_analysis_go/api/health;
        access_log off;
    }

    location /health/python {
        proxy_pass http://apk_analysis_python/api/health;
        access_log off;
    }

    # Prometheus metrics (分别暴露)
    location /metrics/go {
        proxy_pass http://go-backend:9090/metrics;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        deny all;
    }

    location /metrics/python {
        proxy_pass http://python-backend:9091/metrics;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        deny all;
    }
}

# 负载均衡算法说明:
# 1. split_clients - 基于客户端 IP + User-Agent 的一致性哈希
#    - 确保同一客户端始终路由到同一后端
#    - 避免会话不一致问题
#
# 2. weight - 权重配置
#    - Python: 90 (90% 流量)
#    - Go: 10 (10% 流量)
#
# 3. 灰度策略:
#    - 第一周: 10% 流量
#    - 第二周: 30% 流量 (修改 split_clients)
#    - 第三周: 50% 流量
#    - 第四周: 100% 流量 (全量发布)
