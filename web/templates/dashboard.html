<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APK Analysis Dashboard</title>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: #F5F7FA;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 70px;
            background: #1E293B;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 100;
        }

        .sidebar-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
        }

        .sidebar-icon.active {
            background: #5B68FF;
        }

        .sidebar-icon:hover:not(.active) {
            background: #334155;
        }

        /* Main Container */
        .main-container {
            margin-left: 70px;
            padding: 30px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            color: #1E293B;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .icon-btn {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            border: none;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .icon-btn:hover {
            background: #F1F5F9;
        }

        .btn-primary {
            background: #5B68FF;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(91, 104, 255, 0.3);
        }

        .btn-primary:hover {
            background: #4A56E8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(91, 104, 255, 0.4);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-title {
            font-size: 14px;
            color: #64748B;
            font-weight: 500;
        }

        .stat-trend {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .stat-trend.up {
            background: #DCFCE7;
            color: #16A34A;
        }

        .stat-trend.down {
            background: #FEE2E2;
            color: #DC2626;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 8px;
        }

        .stat-description {
            font-size: 13px;
            color: #94A3B8;
        }

        /* Content Section */
        .content-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #1E293B;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 2px solid #F1F5F9;
        }

        .tab {
            padding: 10px 18px;
            border: none;
            background: none;
            color: #64748B;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab.active {
            color: #5B68FF;
            border-bottom-color: #5B68FF;
        }

        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #5B68FF;
            box-shadow: 0 0 0 3px rgba(91, 104, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #94A3B8;
        }

        /* Filter Select */
        .filter-select {
            padding: 10px 16px;
            border: 1px solid #E2E8F0;
            border-radius: 10px;
            font-size: 14px;
            color: #1E293B;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 140px;
        }

        .filter-select:hover {
            border-color: #CBD5E1;
        }

        .filter-select:focus {
            outline: none;
            border-color: #5B68FF;
            box-shadow: 0 0 0 3px rgba(91, 104, 255, 0.1);
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 600;
            color: #64748B;
            background: #F8FAFC;
            border-bottom: 2px solid #F1F5F9;
        }

        tbody tr {
            border-bottom: 1px solid #F1F5F9;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #F8FAFC;
        }

        tbody td {
            padding: 16px;
            font-size: 14px;
            color: #1E293B;
        }

        .checkbox-cell {
            width: 40px;
        }

        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            border-radius: 4px;
        }

        /* Status Badge */
        .status-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-completed {
            background: #DCFCE7;
            color: #16A34A;
        }

        .status-running {
            background: #DBEAFE;
            color: #2563EB;
        }

        .status-queued {
            background: #FEF3C7;
            color: #D97706;
        }

        .status-failed {
            background: #FEE2E2;
            color: #DC2626;
        }

        /* å¤±è´¥ç±»å‹ï¼šæ­£å¸¸ï¼ˆèµ„æºé™åˆ¶ï¼‰ - ç°è‰² */
        .status-failed-normal {
            background: #F1F5F9;
            color: #64748B;
        }

        /* å¤±è´¥ç±»å‹ï¼šè­¦å‘Šï¼ˆéœ€å…³æ³¨ï¼‰ - é»„è‰² */
        .status-failed-warning {
            background: #FEF3C7;
            color: #B45309;
        }

        .status-installing {
            background: #E0E7FF;
            color: #6366F1;
        }

        .status-uploading {
            background: #FEFCE8;
            color: #CA8A04;
        }

        .status-scanning {
            background: #DBEAFE;
            color: #2563EB;
            position: relative;
        }

        .status-scanning::before {
            content: "ğŸ”„ ";
            display: inline-block;
            animation: spin 2s linear infinite;
        }

        /* Static Analysis Link */
        .static-analysis-link {
            color: #5B68FF;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .static-analysis-link:hover {
            color: #4A56E8;
            text-decoration: underline;
        }

        .static-analysis-link::after {
            content: "ğŸ“Š";
            font-size: 12px;
            opacity: 0.6;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 6px;
            background: #F1F5F9;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #5B68FF 0%, #4A56E8 100%);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 12px;
            color: #64748B;
            margin-top: 4px;
        }

        /* Action Button */
        .action-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: none;
            background: #F1F5F9;
            color: #64748B;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 6px;
        }

        .action-btn:hover {
            background: #E2E8F0;
        }

        .action-btn.danger:hover {
            background: #FEE2E2;
            color: #DC2626;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #F1F5F9;
        }

        .pagination-info {
            font-size: 14px;
            color: #64748B;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .pagination-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #F8FAFC;
            border-color: #5B68FF;
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #F1F5F9;
            border-top-color: #5B68FF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 18px;
            color: #1E293B;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: #64748B;
            margin-bottom: 24px;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: #1E293B;
            color: white;
            font-size: 12px;
            border-radius: 6px;
            white-space: nowrap;
            margin-bottom: 8px;
            z-index: 1000;
        }

        /* Domain Tooltip */
        .domain-tooltip {
            position: relative;
            cursor: pointer;
            display: inline-block;
        }

        .domain-tooltip-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #1E293B;
            color: white;
            padding: 12px;
            border-radius: 8px;
            min-width: 200px;
            z-index: 1000;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .domain-tooltip:hover .domain-tooltip-content {
            display: block;
        }

        .domain-tooltip-content .tooltip-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .domain-tooltip-content .tooltip-row:last-child {
            border-bottom: none;
        }

        .domain-tooltip-content .tooltip-label {
            color: #94A3B8;
            margin-right: 12px;
        }

        .domain-tooltip-content .tooltip-value {
            color: white;
            font-weight: 600;
            text-align: right;
        }

        .domain-tooltip-content .score-highlight {
            color: #60A5FA;
            font-size: 14px;
        }

        /* Rules Help Icon & Tooltip */
        .rules-help-icon {
            position: relative;
            display: inline-block;
            margin-left: 6px;
            cursor: help;
            font-size: 14px;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .rules-help-icon:hover {
            opacity: 1;
        }

        .domain-rules-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1E293B;
            color: white;
            padding: 16px;
            border-radius: 12px;
            min-width: 400px;
            max-width: 500px;
            z-index: 2000;
            margin-top: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            max-height: 400px;
            overflow-y: auto;
        }

        .rules-help-icon:hover .domain-rules-tooltip {
            display: block;
        }

        .domain-rules-tooltip .rules-header {
            font-size: 16px;
            font-weight: 700;
            color: #60A5FA;
            margin-bottom: 8px;
            text-align: center;
        }

        .domain-rules-tooltip .rules-summary {
            font-size: 13px;
            color: #94A3B8;
            text-align: center;
            margin-bottom: 12px;
        }

        .domain-rules-tooltip .rules-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 12px 0;
        }

        .domain-rules-tooltip .rules-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .domain-rules-tooltip .rules-table thead th {
            background: rgba(255, 255, 255, 0.05);
            color: #94A3B8;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .domain-rules-tooltip .rules-table tbody td {
            padding: 8px 10px;
            font-size: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .domain-rules-tooltip .rules-table tbody tr:last-child td {
            border-bottom: none;
        }

        .domain-rules-tooltip .rules-table tbody tr.positive td:first-child {
            color: #60A5FA;
        }

        .domain-rules-tooltip .rules-table tbody tr.negative td:first-child {
            color: #F59E0B;
        }

        .domain-rules-tooltip .rules-table tbody td:nth-child(2) {
            color: #94A3B8;
            text-align: center;
            font-weight: 600;
        }

        .domain-rules-tooltip .rules-table tbody td:nth-child(3) {
            color: #CBD5E1;
            font-size: 11px;
        }

        .domain-rules-tooltip .rules-footer {
            font-size: 12px;
            color: #94A3B8;
            text-align: center;
            font-style: italic;
            margin-top: 8px;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .domain-rules-tooltip::-webkit-scrollbar {
            width: 6px;
        }

        .domain-rules-tooltip::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .domain-rules-tooltip::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .domain-rules-tooltip::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Modal æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            max-height: 80vh;
            width: 90%;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #E2E8F0;
            background: #F8FAFC;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1E293B;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #94A3B8;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #E2E8F0;
            color: #475569;
        }

        .modal-body {
            padding: 24px;
            max-height: calc(80vh - 80px);
            overflow-y: auto;
        }

        /* åŸŸåè¯¦æƒ…è¡¨æ ¼æ ·å¼ */
        .domain-details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .domain-details-table thead {
            background: #F8FAFC;
            position: sticky;
            top: 0;
        }

        .domain-details-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #E2E8F0;
        }

        .domain-details-table td {
            padding: 12px;
            border-bottom: 1px solid #F1F5F9;
        }

        .domain-details-table tbody tr:hover {
            background: #F8FAFC;
        }

        .domain-details-table code {
            background: #F1F5F9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-icon active" title="ä»ªè¡¨æ¿" onclick="showSection('dashboard')">ğŸ“Š</div>
        <div class="sidebar-icon" title="ä»»åŠ¡åˆ—è¡¨" onclick="showSection('inventory')">ğŸ“¦</div>
        <div class="sidebar-icon" title="SDK è§„åˆ™" onclick="showSection('sdk-rules')">ğŸ”§</div>
        <div class="sidebar-icon" title="è®¾ç½®">âš™ï¸</div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Header -->
        <div class="header" id="main-header">
            <h1>APK åŠ¨æ€åˆ†æå¹³å°</h1>
            <div class="header-actions">
                <button class="icon-btn tooltip" data-tooltip="é€šçŸ¥">ğŸ””</button>
                <button class="icon-btn tooltip" data-tooltip="è®¾ç½®">âš™ï¸</button>
                <button class="btn-primary" onclick="showUploadDialog()">
                    <span>ğŸ“¤</span>
                    <span>ä¸Šä¼  APK</span>
                </button>
                <div style="display: flex; align-items: center; gap: 10px; margin-left: 15px; padding-left: 15px; border-left: 1px solid #E2E8F0;">
                    <span style="color: #64748B; font-size: 14px;">ğŸ‘¤ <span id="current-user">ç”¨æˆ·</span></span>
                    <button class="icon-btn tooltip" data-tooltip="é€€å‡ºç™»å½•" onclick="logout()" style="color: #EF4444;">ğŸšª</button>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid" id="main-stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">æ€»ä»»åŠ¡æ•°</div>
                    <div class="stat-trend up">â†‘ 45.00%</div>
                </div>
                <div class="stat-value" id="stat-total">-</div>
                <div class="stat-description">å·²åˆ†æçš„ APK æ–‡ä»¶æ€»æ•°</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">å·²å®Œæˆ</div>
                    <div class="stat-trend up">â†‘ 200.00%</div>
                </div>
                <div class="stat-value" id="stat-completed">-</div>
                <div class="stat-description">æˆåŠŸåˆ†æå®Œæˆçš„ä»»åŠ¡</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">è¿è¡Œä¸­</div>
                    <div class="stat-trend down">â†“ 0.00%</div>
                </div>
                <div class="stat-value" id="stat-running">-</div>
                <div class="stat-description">æ­£åœ¨æ‰§è¡Œçš„åˆ†æä»»åŠ¡</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">å¤±è´¥ä»»åŠ¡</div>
                    <div class="stat-trend down">â†“ 0.00%</div>
                </div>
                <div class="stat-value" id="stat-failed">-</div>
                <div class="stat-description">åˆ†æå¤±è´¥çš„ä»»åŠ¡æ•°é‡</div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="content-section" id="dashboard-section">
            <div class="section-header">
                <div class="section-title">ç³»ç»Ÿæ¦‚è§ˆ</div>
                <button class="icon-btn" onclick="refreshDashboard()" title="åˆ·æ–°">ğŸ”„</button>
            </div>

            <!-- System Status Cards -->
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">è®¾å¤‡çŠ¶æ€</div>
                        <div class="stat-trend" id="devices-status-badge" style="background: #DCFCE7; color: #16A34A;">âœ“ åœ¨çº¿</div>
                    </div>
                    <div class="stat-value" id="devices-available">-</div>
                    <div class="stat-description">å¯ç”¨è®¾å¤‡ / æ€»è®¾å¤‡æ•°</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">é™æ€åˆ†æ</div>
                        <div class="stat-trend" style="background: #DCFCE7; color: #16A34A;">Hybrid</div>
                    </div>
                    <div class="stat-value">Go+Androguard</div>
                    <div class="stat-description">æ··åˆé™æ€åˆ†ææ¨¡å¼</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">SDK è§„åˆ™</div>
                    </div>
                    <div class="stat-value" id="sdk-rules-count">-</div>
                    <div class="stat-description">æ´»è·ƒçš„ç¬¬ä¸‰æ–¹SDKè§„åˆ™</div>
                </div>
            </div>

            <!-- Devices Grid -->
            <div style="margin-bottom: 30px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #1E293B; margin-bottom: 16px;">Android æ¨¡æ‹Ÿå™¨</h3>
                <div class="stats-grid" id="devices-grid">
                    <div class="stat-card" style="text-align: center; padding: 40px;">
                        <div class="loading-spinner"></div>
                        <div style="margin-top: 16px; color: #64748B;">æ­£åœ¨åŠ è½½è®¾å¤‡ä¿¡æ¯...</div>
                    </div>
                </div>
            </div>

            <!-- Recent Tasks -->
            <div>
                <h3 style="font-size: 18px; font-weight: 600; color: #1E293B; margin-bottom: 16px;">æœ€è¿‘ä»»åŠ¡</h3>
                <table>
                    <thead>
                        <tr>
                            <th>APK åç§°</th>
                            <th>åŒ…å</th>
                            <th>çŠ¶æ€</th>
                            <th>è¿›åº¦</th>
                            <th>é™æ€åˆ†æ</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-recent-tasks">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner"></div>
                                <div style="margin-top: 16px; color: #64748B;">æ­£åœ¨åŠ è½½ä»»åŠ¡...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Content Section -->
        <div class="content-section" id="inventory-section" style="display: none;">
            <div class="section-header">
                <div class="section-title">ä»»åŠ¡ç®¡ç†</div>
                <button class="icon-btn" onclick="refreshTasks()" title="åˆ·æ–°">ğŸ”„</button>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="filterTasks('all')">å…¨éƒ¨</button>
                <button class="tab" onclick="filterTasks('completed')">å·²å®Œæˆ</button>
                <button class="tab" onclick="filterTasks('running')">è¿è¡Œä¸­</button>
                <button class="tab" onclick="filterTasks('failed')">å¤±è´¥</button>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <div class="search-box">
                    <input type="text" placeholder="æœç´¢ APK åç§°æˆ–åŒ…å..." id="search-input" oninput="filterTasksBySearch()">
                    <span class="search-icon">ğŸ”</span>
                </div>

                <!-- é«˜çº§ç­›é€‰ -->
                <select id="province-filter" class="filter-select" onchange="applyAdvancedFilters()">
                    <option value="">å…¨éƒ¨çœä»½</option>
                    <!-- ç›´è¾–å¸‚ -->
                    <option value="åŒ—äº¬">åŒ—äº¬</option>
                    <option value="å¤©æ´¥">å¤©æ´¥</option>
                    <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                    <option value="é‡åº†">é‡åº†</option>
                    <!-- çœä»½ -->
                    <option value="æ²³åŒ—">æ²³åŒ—</option>
                    <option value="å±±è¥¿">å±±è¥¿</option>
                    <option value="è¾½å®">è¾½å®</option>
                    <option value="å‰æ—">å‰æ—</option>
                    <option value="é»‘é¾™æ±Ÿ">é»‘é¾™æ±Ÿ</option>
                    <option value="æ±Ÿè‹">æ±Ÿè‹</option>
                    <option value="æµ™æ±Ÿ">æµ™æ±Ÿ</option>
                    <option value="å®‰å¾½">å®‰å¾½</option>
                    <option value="ç¦å»º">ç¦å»º</option>
                    <option value="æ±Ÿè¥¿">æ±Ÿè¥¿</option>
                    <option value="å±±ä¸œ">å±±ä¸œ</option>
                    <option value="æ²³å—">æ²³å—</option>
                    <option value="æ¹–åŒ—">æ¹–åŒ—</option>
                    <option value="æ¹–å—">æ¹–å—</option>
                    <option value="å¹¿ä¸œ">å¹¿ä¸œ</option>
                    <option value="æµ·å—">æµ·å—</option>
                    <option value="å››å·">å››å·</option>
                    <option value="è´µå·">è´µå·</option>
                    <option value="äº‘å—">äº‘å—</option>
                    <option value="é™•è¥¿">é™•è¥¿</option>
                    <option value="ç”˜è‚ƒ">ç”˜è‚ƒ</option>
                    <option value="é’æµ·">é’æµ·</option>
                    <option value="å°æ¹¾">å°æ¹¾</option>
                    <!-- è‡ªæ²»åŒº -->
                    <option value="å†…è’™å¤">å†…è’™å¤</option>
                    <option value="å¹¿è¥¿">å¹¿è¥¿</option>
                    <option value="è¥¿è—">è¥¿è—</option>
                    <option value="å®å¤">å®å¤</option>
                    <option value="æ–°ç–†">æ–°ç–†</option>
                    <!-- ç‰¹åˆ«è¡Œæ”¿åŒº -->
                    <option value="é¦™æ¸¯">é¦™æ¸¯</option>
                    <option value="æ¾³é—¨">æ¾³é—¨</option>
                </select>

                <select id="isp-filter" class="filter-select" onchange="applyAdvancedFilters()">
                    <option value="">å…¨éƒ¨ISP</option>
                    <option value="ç”µä¿¡">ç”µä¿¡</option>
                    <option value="ç§»åŠ¨">ç§»åŠ¨</option>
                    <option value="è”é€š">è”é€š</option>
                    <option value="ç”µä¿¡&è”é€š">ç”µä¿¡&è”é€š</option>
                    <option value="ç”µä¿¡&ç§»åŠ¨">ç”µä¿¡&ç§»åŠ¨</option>
                    <option value="ç”µä¿¡&è”é€š&ç§»åŠ¨">ç”µä¿¡&è”é€š&ç§»åŠ¨</option>
                    <option value="é“é€š">é“é€š</option>
                    <option value="å¹¿ç”µ">å¹¿ç”µ</option>
                    <option value="263ç½‘ç»œé€šä¿¡">263ç½‘ç»œé€šä¿¡</option>
                    <option value="é˜¿é‡Œäº‘">é˜¿é‡Œäº‘</option>
                    <option value="è…¾è®¯äº‘">è…¾è®¯äº‘</option>
                    <option value="åä¸ºäº‘">åä¸ºäº‘</option>
                    <option value="ç™¾åº¦äº‘">ç™¾åº¦äº‘</option>
                    <option value="äº¬ä¸œäº‘">äº¬ä¸œäº‘</option>
                    <option value="é‡‘å±±äº‘">é‡‘å±±äº‘</option>
                    <option value="ç½‘æ˜“äº‘">ç½‘æ˜“äº‘</option>
                    <option value="ç¾å›¢äº‘">ç¾å›¢äº‘</option>
                    <option value="å­—èŠ‚è·³åŠ¨">å­—èŠ‚è·³åŠ¨</option>
                    <option value="ä¼˜åˆ»äº‘">ä¼˜åˆ»äº‘</option>
                    <option value="ä¸–çºªäº’è”">ä¸–çºªäº’è”</option>
                    <option value="äºšé©¬é€Šäº‘">äºšé©¬é€Šäº‘</option>
                    <option value="å¾®è½¯äº‘">å¾®è½¯äº‘</option>
                    <option value="è°·æ­Œäº‘">è°·æ­Œäº‘</option>
                    <option value="Cloudflare">Cloudflare</option>
                    <option value="Akamai">Akamai</option>
                </select>

                <select id="beian-filter" class="filter-select" onchange="applyAdvancedFilters()">
                    <option value="">å…¨éƒ¨å¤‡æ¡ˆçŠ¶æ€</option>
                    <option value="å·²å¤‡æ¡ˆ">å·²å¤‡æ¡ˆ</option>
                    <option value="æœªå¤‡æ¡ˆ">æœªå¤‡æ¡ˆ</option>
                    <option value="æŸ¥è¯¢å¤±è´¥">æŸ¥è¯¢å¤±è´¥</option>
                </select>

                <button class="action-btn" id="export-btn" onclick="exportFilteredTasks()">ğŸ“¥ å¯¼å‡ºå…¨éƒ¨</button>
                <button class="btn-primary" onclick="showQueueModal()">
                    <span>â³</span>
                    <span>é˜Ÿåˆ—ç®¡ç†</span>
                </button>
                <button class="btn-primary" onclick="showAIInteractionModal()" style="background: #10B981;">
                    <span>ğŸ¤–</span>
                    <span>AI äº¤äº’ç›‘æ§</span>
                </button>
            </div>

            <!-- Table -->
            <div id="tasks-table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" id="select-all"></th>
                            <th>APK åç§°</th>
                            <th>åº”ç”¨åç§°</th>
                            <th>åŒ…å</th>
                            <th>çŠ¶æ€</th>
                            <th>è¿›åº¦</th>
                            <th>é™æ€åˆ†æ</th>
                            <th>
                                ä¸»åŸŸå
                                <span class="rules-help-icon">
                                    â“
                                    <div class="domain-rules-tooltip">
                                        <div class="rules-header">åŸŸåè¯„åˆ†è§„åˆ™è¯´æ˜</div>
                                        <div class="rules-summary">æ€»åˆ†èŒƒå›´: -12 ~ 40 åˆ†ï¼ˆåŠ¨æ€å½’ä¸€åŒ–ï¼‰</div>
                                        <div class="rules-divider"></div>
                                        <table class="rules-table">
                                            <thead>
                                                <tr>
                                                    <th>è¯„åˆ†ç»´åº¦</th>
                                                    <th>åˆ†å€¼</th>
                                                    <th>è¯´æ˜</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="positive">
                                                    <td>âœ“ åŒ…ååŒ¹é…</td>
                                                    <td>0-15</td>
                                                    <td>åŸŸåä¸åŒ…åç›¸ä¼¼åº¦</td>
                                                </tr>
                                                <tr class="positive">
                                                    <td>ğŸ“Š URLé¢‘ç‡</td>
                                                    <td>0-8</td>
                                                    <td>è¯·æ±‚æ¬¡æ•°å½’ä¸€åŒ–</td>
                                                </tr>
                                                <tr class="positive">
                                                    <td>ğŸŒ³ è·¯å¾„å¤šæ ·æ€§</td>
                                                    <td>0-5</td>
                                                    <td>å”¯ä¸€è·¯å¾„æ•°é‡</td>
                                                </tr>
                                                <tr class="positive">
                                                    <td>ğŸ”— å­åŸŸåæ•°é‡</td>
                                                    <td>0-4</td>
                                                    <td>å­åŸŸåä¸°å¯Œåº¦</td>
                                                </tr>
                                                <tr class="positive">
                                                    <td>ğŸ”Œ APIç‰¹å¾</td>
                                                    <td>0-5</td>
                                                    <td>å«/api/,/v1/ç­‰</td>
                                                </tr>
                                                <tr class="positive">
                                                    <td>ğŸ” è®¤è¯ç‰¹å¾</td>
                                                    <td>0-3</td>
                                                    <td>å«/login,/authç­‰</td>
                                                </tr>
                                                <tr class="negative">
                                                    <td>âš  CDNæƒ©ç½š</td>
                                                    <td>-2</td>
                                                    <td>å«cdn,staticç­‰</td>
                                                </tr>
                                                <tr class="negative">
                                                    <td>âœ— SDKæƒ©ç½š</td>
                                                    <td>-10</td>
                                                    <td>ç¬¬ä¸‰æ–¹SDKåŸŸå</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <div class="rules-divider"></div>
                                        <div class="rules-footer">
                                            ç½®ä¿¡åº¦ = æ€»åˆ† Ã· å½’ä¸€åŒ–åŸºæ•°<br/>
                                            <small style="color: #94A3B8;">æœ‰åŒ…ååŒ¹é…: Ã·40 | æ— åŒ…ååŒ¹é…: Ã·25</small>
                                        </div>
                                    </div>
                                </span>
                            </th>
                            <th>å¤‡æ¡ˆ</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>å®Œæˆæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tasks-tbody">
                        <tr>
                            <td colspan="12" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner"></div>
                                <div style="margin-top: 16px; color: #64748B;">æ­£åœ¨åŠ è½½ä»»åŠ¡...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <div class="pagination-info" id="pagination-info">1-10 of 286</div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="prev-page" onclick="previousPage()">â†</button>
                    <button class="pagination-btn" id="next-page" onclick="nextPage()">â†’</button>
                </div>
            </div>
        </div>

        <!-- SDK Rules Section -->
        <div class="content-section" id="sdk-rules-section" style="display: none;">
            <div class="section-header">
                <div class="section-title">SDK è§„åˆ™ç®¡ç†</div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-primary" onclick="showAddSDKRuleModal()">
                        <span>â•</span>
                        <span>æ·»åŠ è§„åˆ™</span>
                    </button>
                    <button class="icon-btn" onclick="refreshSDKRules()" title="åˆ·æ–°">ğŸ”„</button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">æ€»è§„åˆ™æ•°</div>
                    </div>
                    <div class="stat-value" id="sdk-total-count">-</div>
                    <div class="stat-description">æ‰€æœ‰ç¬¬ä¸‰æ–¹ SDK è§„åˆ™</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">æ´»è·ƒè§„åˆ™</div>
                    </div>
                    <div class="stat-value" id="sdk-active-count">-</div>
                    <div class="stat-description">çŠ¶æ€ä¸º active çš„è§„åˆ™</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">å¾…å®¡æ ¸</div>
                    </div>
                    <div class="stat-value" id="sdk-pending-count">-</div>
                    <div class="stat-description">ç­‰å¾…å®¡æ ¸çš„è§„åˆ™</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">åˆ†ç±»æ•°é‡</div>
                    </div>
                    <div class="stat-value" id="sdk-category-count">-</div>
                    <div class="stat-description">ä¸åŒçš„è§„åˆ™åˆ†ç±»</div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="action-bar">
                <div class="search-box">
                    <input type="text" placeholder="æœç´¢åŸŸåã€æä¾›å•†..." id="sdk-search-input" oninput="filterSDKRules()">
                    <span class="search-icon">ğŸ”</span>
                </div>
                <select id="sdk-category-filter" onchange="filterSDKRules()" style="padding: 10px; border: 1px solid #E2E8F0; border-radius: 10px; font-size: 14px;">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="analytics">æ•°æ®åˆ†æ</option>
                    <option value="ad">å¹¿å‘Š</option>
                    <option value="push">æ¨é€</option>
                    <option value="payment">æ”¯ä»˜</option>
                    <option value="social">ç¤¾äº¤åˆ†äº«</option>
                    <option value="multimedia">å¤šåª’ä½“</option>
                    <option value="other">å…¶ä»–</option>
                </select>
                <select id="sdk-status-filter" onchange="filterSDKRules()" style="padding: 10px; border: 1px solid #E2E8F0; border-radius: 10px; font-size: 14px;">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="active">æ´»è·ƒ</option>
                    <option value="pending">å¾…å®¡æ ¸</option>
                    <option value="disabled">å·²ç¦ç”¨</option>
                </select>
            </div>

            <!-- SDK Rules Table -->
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åŸŸå</th>
                        <th>åˆ†ç±»</th>
                        <th>æä¾›å•†</th>
                        <th>ç½®ä¿¡åº¦</th>
                        <th>çŠ¶æ€</th>
                        <th>ä¼˜å…ˆçº§</th>
                        <th>å‘ç°æ¬¡æ•°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="sdk-rules-tbody">
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px;">
                            <div class="loading-spinner"></div>
                            <div style="margin-top: 16px; color: #64748B;">æ­£åœ¨åŠ è½½ SDK è§„åˆ™...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Queue Management Modal -->
    <div id="queue-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; width: 90%; max-width: 1000px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 24px; border-bottom: 1px solid #F1F5F9;">
                <h2 style="font-size: 20px; font-weight: 600; color: #1E293B; margin: 0;">â³ é˜Ÿåˆ—ç®¡ç†</h2>
                <button onclick="closeQueueModal()" style="width: 36px; height: 36px; border-radius: 8px; border: none; background: #F1F5F9; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">âœ•</button>
            </div>
            <div style="padding: 24px; overflow-y: auto; max-height: calc(80vh - 100px);">
                <div id="queue-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div style="background: #FEF3C7; padding: 16px; border-radius: 12px;">
                        <div style="font-size: 13px; color: #92400E; margin-bottom: 4px;">æ’é˜Ÿä»»åŠ¡æ•°</div>
                        <div style="font-size: 28px; font-weight: 700; color: #D97706;" id="queue-count">-</div>
                    </div>
                    <div style="background: #DBEAFE; padding: 16px; border-radius: 12px;">
                        <div style="font-size: 13px; color: #1E3A8A; margin-bottom: 4px;">å¹³å‡ç­‰å¾…æ—¶é—´</div>
                        <div style="font-size: 28px; font-weight: 700; color: #2563EB;" id="queue-avg-wait">-</div>
                    </div>
                    <div style="background: #DCFCE7; padding: 16px; border-radius: 12px;">
                        <div style="font-size: 13px; color: #14532D; margin-bottom: 4px;">é˜Ÿåˆ—çŠ¶æ€</div>
                        <div style="font-size: 28px; font-weight: 700; color: #16A34A;" id="queue-status">æ­£å¸¸</div>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #F8FAFC; border-bottom: 2px solid #F1F5F9;">
                            <th style="text-align: left; padding: 12px 16px; font-size: 13px; font-weight: 600; color: #64748B;">APK åç§°</th>
                            <th style="text-align: left; padding: 12px 16px; font-size: 13px; font-weight: 600; color: #64748B;">åŒ…å</th>
                            <th style="text-align: left; padding: 12px 16px; font-size: 13px; font-weight: 600; color: #64748B;">çŠ¶æ€</th>
                            <th style="text-align: left; padding: 12px 16px; font-size: 13px; font-weight: 600; color: #64748B;">åˆ›å»ºæ—¶é—´</th>
                            <th style="text-align: left; padding: 12px 16px; font-size: 13px; font-weight: 600; color: #64748B;">ç­‰å¾…æ—¶é•¿</th>
                        </tr>
                    </thead>
                    <tbody id="queue-tasks-tbody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #64748B;">
                                <div class="loading-spinner"></div>
                                <div style="margin-top: 16px;">æ­£åœ¨åŠ è½½é˜Ÿåˆ—æ•°æ®...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- AI Interaction Monitor Modal -->
    <div id="ai-interaction-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; width: 95%; max-width: 1400px; height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid #F1F5F9; background: #10B981;">
                <h2 style="font-size: 20px; font-weight: 600; color: white; margin: 0;">ğŸ¤– AI äº¤äº’ç›‘æ§</h2>
                <button onclick="closeAIInteractionModal()" style="width: 36px; height: 36px; border-radius: 8px; border: none; background: rgba(255,255,255,0.2); cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; color: white;">âœ•</button>
            </div>
            <iframe id="ai-interaction-iframe" src="" style="width: 100%; height: calc(100% - 60px); border: none;"></iframe>
        </div>
    </div>

    <!-- SDK Rule Add/Edit Modal -->
    <div id="sdk-rule-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 24px; border-bottom: 1px solid #F1F5F9;">
                <h2 style="font-size: 20px; font-weight: 600; color: #1E293B; margin: 0;" id="sdk-modal-title">æ·»åŠ  SDK è§„åˆ™</h2>
                <button onclick="closeSDKRuleModal()" style="width: 36px; height: 36px; border-radius: 8px; border: none; background: #F1F5F9; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">âœ•</button>
            </div>
            <div style="padding: 24px; overflow-y: auto; max-height: calc(80vh - 150px);">
                <form id="sdk-rule-form">
                    <input type="hidden" id="sdk-rule-id">

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">åŸŸå *</label>
                        <input type="text" id="sdk-domain" required style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px;" placeholder="ä¾‹å¦‚: api.example.com">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">åˆ†ç±» *</label>
                        <select id="sdk-category" required style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px;">
                            <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                            <option value="analytics">æ•°æ®åˆ†æ</option>
                            <option value="ad">å¹¿å‘Š</option>
                            <option value="push">æ¨é€</option>
                            <option value="payment">æ”¯ä»˜</option>
                            <option value="social">ç¤¾äº¤åˆ†äº«</option>
                            <option value="multimedia">å¤šåª’ä½“</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">å­åˆ†ç±»</label>
                        <input type="text" id="sdk-sub-category" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px;" placeholder="ä¾‹å¦‚: video_processing">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">æä¾›å•† *</label>
                        <input type="text" id="sdk-provider" required style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px;" placeholder="ä¾‹å¦‚: Google Analytics">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">æè¿°</label>
                        <textarea id="sdk-description" rows="3" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px; resize: vertical;" placeholder="SDK çš„è¯¦ç»†è¯´æ˜"></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">ç½®ä¿¡åº¦</label>
                            <input type="number" id="sdk-confidence" min="0" max="1" step="0.01" value="1.00" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">ä¼˜å…ˆçº§</label>
                            <input type="number" id="sdk-priority" min="0" max="100" value="50" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-size: 14px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">çŠ¶æ€</label>
                        <select id="sdk-status" style="width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px;">
                            <option value="active">æ´»è·ƒ</option>
                            <option value="pending">å¾…å®¡æ ¸</option>
                            <option value="disabled">å·²ç¦ç”¨</option>
                        </select>
                    </div>
                </form>
            </div>
            <div style="padding: 20px 24px; border-top: 1px solid #F1F5F9; display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="closeSDKRuleModal()" class="action-btn" style="padding: 10px 20px;">å–æ¶ˆ</button>
                <button onclick="saveSDKRule()" class="btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let tasksPerPage = 20;
        let allTasks = [];
        let filteredTasks = [];
        let currentFilter = 'all';
        let searchQuery = '';
        let totalTasks = 0;
        let totalPages = 0;

        // é«˜çº§ç­›é€‰æ¡ä»¶
        let provinceFilter = '';
        let ispFilter = '';
        let beianFilter = '';

        // è®¤è¯æ£€æŸ¥
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        // è·å–è®¤è¯ headers
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            };
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('role');
            window.location.href = '/login';
        }

        // æ˜¾ç¤ºå½“å‰ç”¨æˆ·
        function showCurrentUser() {
            const username = localStorage.getItem('username') || 'ç”¨æˆ·';
            const userDisplay = document.getElementById('current-user');
            if (userDisplay) {
                userDisplay.textContent = username;
            }
        }

        // Load tasks on page load
        window.addEventListener('DOMContentLoaded', () => {
            // é¦–å…ˆæ£€æŸ¥è®¤è¯
            if (!checkAuth()) return;

            showCurrentUser();
            loadStats();
            loadTasks();
            loadDashboard(); // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®ï¼ˆè®¾å¤‡çŠ¶æ€ã€æœ€è¿‘ä»»åŠ¡ç­‰ï¼‰
            // Auto-refresh every 5 seconds
            setInterval(loadTasks, 5000);
            setInterval(loadStats, 10000);
            setInterval(loadDashboard, 5000); // è‡ªåŠ¨åˆ·æ–°ä»ªè¡¨ç›˜
        });

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                document.getElementById('stat-total').textContent = data.total_tasks || 0;
                document.getElementById('stat-completed').textContent = data.status_breakdown?.completed || 0;
                document.getElementById('stat-running').textContent = data.status_breakdown?.running || 0;
                document.getElementById('stat-failed').textContent = data.status_breakdown?.failed || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadTasks() {
            try {
                // æ„å»ºæŸ¥è¯¢å‚æ•°
                let queryParams = `page=${currentPage}&page_size=${tasksPerPage}&exclude_status=queued`;

                // æ·»åŠ çŠ¶æ€è¿‡æ»¤å‚æ•°ï¼ˆTab è¿‡æ»¤ï¼‰
                if (currentFilter && currentFilter !== 'all') {
                    queryParams += `&status=${encodeURIComponent(currentFilter)}`;
                }

                // æ·»åŠ é«˜çº§ç­›é€‰å‚æ•°
                if (provinceFilter) {
                    queryParams += `&province=${encodeURIComponent(provinceFilter)}`;
                }
                if (ispFilter) {
                    queryParams += `&isp=${encodeURIComponent(ispFilter)}`;
                }
                if (beianFilter) {
                    queryParams += `&beian_status=${encodeURIComponent(beianFilter)}`;
                }
                // æ·»åŠ æœç´¢å‚æ•°
                if (searchQuery) {
                    queryParams += `&search=${encodeURIComponent(searchQuery)}`;
                }

                const response = await fetch(`/api/tasks?${queryParams}`);
                const data = await response.json();

                // æ–°APIè¿”å›åˆ†é¡µæ•°æ®ç»“æ„
                if (data.tasks) {
                    allTasks = data.tasks;
                    totalTasks = data.total;
                    totalPages = data.total_pages;
                } else {
                    // å…¼å®¹æ—§APIï¼ˆè¿”å›æ•°ç»„ï¼‰
                    allTasks = data;
                    totalTasks = data.length;
                    totalPages = Math.ceil(totalTasks / tasksPerPage);
                }

                // ä¿å­˜å½“å‰ä»»åŠ¡æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›Modalä½¿ç”¨
                window.currentTasks = allTasks;

                // æœç´¢å·²åœ¨æœåŠ¡ç«¯å®Œæˆï¼Œç›´æ¥ä½¿ç”¨è¿”å›çš„æ•°æ®
                filteredTasks = allTasks;
                renderTasks();
            } catch (error) {
                console.error('Failed to load tasks:', error);
                showEmptyState('Failed to load tasks');
            }
        }

        // åº”ç”¨é«˜çº§ç­›é€‰
        function applyAdvancedFilters() {
            provinceFilter = document.getElementById('province-filter').value;
            ispFilter = document.getElementById('isp-filter').value;
            beianFilter = document.getElementById('beian-filter').value;

            // æ›´æ–°å¯¼å‡ºæŒ‰é’®æ–‡æ¡ˆ
            updateExportButtonText();

            // é‡ç½®åˆ°ç¬¬ä¸€é¡µå¹¶é‡æ–°åŠ è½½
            currentPage = 1;
            loadTasks();
        }

        function filterTasks(filter) {
            currentFilter = filter;
            currentPage = 1;  // é‡ç½®åˆ°ç¬¬ä¸€é¡µ

            // Update tab UI
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // é‡æ–°ä»æœåŠ¡ç«¯åŠ è½½æ•°æ®ï¼ˆå¸¦çŠ¶æ€è¿‡æ»¤ï¼‰
            loadTasks();
        }

        // é˜²æŠ–å®šæ—¶å™¨
        let searchDebounceTimer = null;

        function filterTasksBySearch() {
            searchQuery = document.getElementById('search-input').value.trim();

            // æ›´æ–°å¯¼å‡ºæŒ‰é’®æ–‡æ¡ˆ
            updateExportButtonText();

            // ä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }

            searchDebounceTimer = setTimeout(() => {
                // é‡ç½®åˆ°ç¬¬ä¸€é¡µå¹¶é‡æ–°ä»æœåŠ¡ç«¯åŠ è½½ï¼ˆå¸¦æœç´¢å‚æ•°ï¼‰
                currentPage = 1;
                loadTasks();
            }, 300); // 300ms é˜²æŠ–
        }

        function renderTasks() {
            const tbody = document.getElementById('tasks-tbody');

            if (filteredTasks.length === 0) {
                showEmptyState('No tasks found');
                return;
            }

            // æœåŠ¡å™¨ç«¯åˆ†é¡µï¼Œç›´æ¥æ˜¾ç¤ºæ‰€æœ‰filteredTasksï¼ˆä¸å†è¿›è¡Œå‰ç«¯åˆ‡ç‰‡ï¼‰
            const tasksToShow = filteredTasks;

            tbody.innerHTML = tasksToShow.map(task => `
                <tr>
                    <td class="checkbox-cell"><input type="checkbox"></td>
                    <td><strong>${task.apk_name || 'N/A'}</strong></td>
                    <td style="color: #10B981;">${task.app_name || '-'}</td>
                    <td style="color: #64748B; font-size: 13px;">${task.package_name || 'N/A'}</td>
                    <td>${formatFailureStatus(task)}</td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${task.progress_percent || 0}%"></div>
                        </div>
                        <div class="progress-text">${task.progress_percent || 0}% - ${task.current_step || 'å¾…å¤„ç†'}</div>
                    </td>
                    <td>${formatStaticAnalysis(task)}</td>
                    <td>${formatDomainAndIPs(task)}</td>
                    <td>${formatBeian(task.domain_beian_status)}</td>
                    <td style="font-size: 13px; color: #64748B;">${formatDate(task.created_at)}</td>
                    <td style="font-size: 13px; color: #64748B;">${formatDate(task.completed_at)}</td>
                    <td>
                        <button class="action-btn" onclick="viewTask('${task.id}')" title="æŸ¥çœ‹è¯¦æƒ…">ğŸ‘ï¸</button>
                        <button class="action-btn" onclick="viewActivities('${task.id}')" title="Activityè¯¦æƒ…">ğŸ“±</button>
                        <button class="action-btn" onclick="viewURLs('${task.id}')" title="URLåˆ†æ">ğŸ”—</button>
                        <button class="action-btn danger" onclick="deleteTask('${task.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');

            updatePagination();
        }

        function showEmptyState(message) {
            const tbody = document.getElementById('tasks-tbody');
            const translatedMessage = message === 'No tasks found' ? 'æœªæ‰¾åˆ°ä»»åŠ¡' :
                                     message === 'Failed to load tasks' ? 'åŠ è½½ä»»åŠ¡å¤±è´¥' : message;
            tbody.innerHTML = `
                <tr>
                    <td colspan="12">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <h3>${translatedMessage}</h3>
                            <p>å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–ä¸Šä¼ æ–°çš„ APK æ–‡ä»¶</p>
                        </div>
                    </td>
                </tr>
            `;
        }

        function updatePagination() {
            const startIndex = (currentPage - 1) * tasksPerPage + 1;
            const endIndex = Math.min(startIndex + tasksPerPage - 1, totalTasks);

            document.getElementById('pagination-info').textContent =
                `${startIndex}-${endIndex} of ${totalTasks}`;

            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadTasks(); // ä»æœåŠ¡å™¨é‡æ–°åŠ è½½ä¸Šä¸€é¡µæ•°æ®
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadTasks(); // ä»æœåŠ¡å™¨é‡æ–°åŠ è½½ä¸‹ä¸€é¡µæ•°æ®
            }
        }

        function formatStatus(status) {
            const statusMap = {
                'completed': 'å·²å®Œæˆ',
                'running': 'è¿è¡Œä¸­',
                'queued': 'æ’é˜Ÿä¸­',
                'failed': 'å¤±è´¥',
                'installing': 'å®‰è£…ä¸­',
                'collecting': 'æ”¶é›†ä¸­'
            };
            return statusMap[status] || status;
        }

        // æ ¼å¼åŒ–å¤±è´¥çŠ¶æ€ï¼ˆåŒ…å«å¤±è´¥ç±»å‹ï¼‰
        function formatFailureStatus(task) {
            if (task.status !== 'failed') {
                return `<span class="status-badge status-${task.status}">${formatStatus(task.status)}</span>`;
            }

            // å¤±è´¥ä»»åŠ¡ï¼šæ˜¾ç¤ºå¤±è´¥ç±»å‹
            const failureType = task.failure_type || '';
            const failureDisplay = task.failure_type_display || 'å¤±è´¥';
            const severity = task.failure_severity || 'error';

            // æ ¹æ®ä¸¥é‡ç¨‹åº¦è®¾ç½®é¢œè‰²
            let colorClass = 'status-failed';
            if (severity === 'normal') {
                colorClass = 'status-failed-normal';  // ç°è‰²ï¼Œæ­£å¸¸çš„èµ„æºé™åˆ¶
            } else if (severity === 'warning') {
                colorClass = 'status-failed-warning'; // é»„è‰²ï¼Œéœ€å…³æ³¨
            }

            return `<span class="status-badge ${colorClass}" title="${task.error_message || ''}">${failureDisplay}</span>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatDomain(domainJson) {
            if (!domainJson) return 'N/A';
            try {
                const data = JSON.parse(domainJson);
                return data.primary_domain || 'N/A';
            } catch {
                return 'N/A';
            }
        }

        function formatDomainAndIPs(task) {
            // æå–ä¸»åŸŸååŠå…¶è¯¦ç»†ä¿¡æ¯
            let domain = 'N/A';
            let domainData = null;
            let primaryCandidate = null;

            if (task.primary_domain) {
                try {
                    domainData = JSON.parse(task.primary_domain);
                    domain = domainData.primary_domain || 'N/A';

                    // æ‰¾åˆ°ä¸»åŸŸåçš„å€™é€‰ä¿¡æ¯
                    if (domainData.candidates && Array.isArray(domainData.candidates)) {
                        primaryCandidate = domainData.candidates.find(c => c.domain === domain);
                    }
                } catch {
                    domain = 'N/A';
                }
            }

            // æ„å»ºä¸»åŸŸåHTMLï¼ˆå¸¦æ‚¬åœæç¤ºæ¡†ï¼Œå±•ç¤ºæ–°çš„è¯„åˆ†ç»´åº¦ï¼‰
            let domainHtml = domain;
            if (primaryCandidate) {
                // è®¡ç®—ç½®ä¿¡åº¦ç™¾åˆ†æ¯”
                const confidence = domainData.confidence ? Math.round(domainData.confidence * 100) : 0;

                // è·å–è¯„åˆ†è¯¦æƒ…ï¼ˆæ–°ç‰ˆæœ¬æ”¯æŒè¯¦ç»†ç»´åº¦ï¼‰
                const packageScore = primaryCandidate.package_score !== undefined ? primaryCandidate.package_score.toFixed(1) : (primaryCandidate.package_match ? '15.0' : '0');
                const frequencyScore = primaryCandidate.frequency_score !== undefined ? primaryCandidate.frequency_score.toFixed(1) : '0';
                const pathScore = primaryCandidate.path_score !== undefined ? primaryCandidate.path_score.toFixed(1) : '0';
                const subdomainScore = primaryCandidate.subdomain_score !== undefined ? primaryCandidate.subdomain_score.toFixed(1) : '0';
                const dynamicScore = primaryCandidate.dynamic_score !== undefined ? primaryCandidate.dynamic_score.toFixed(1) : '0';
                const apiScore = primaryCandidate.api_score !== undefined ? primaryCandidate.api_score.toFixed(1) : '0';
                const authScore = primaryCandidate.auth_score !== undefined ? primaryCandidate.auth_score.toFixed(1) : '0';
                const cdnPenalty = primaryCandidate.cdn_penalty !== undefined ? primaryCandidate.cdn_penalty.toFixed(1) : '0';
                const sdkPenalty = primaryCandidate.sdk_penalty !== undefined ? primaryCandidate.sdk_penalty.toFixed(1) : '0';

                const totalScore = primaryCandidate.score !== undefined ? primaryCandidate.score.toFixed(1) : '0';
                const pathCount = primaryCandidate.path_count || 0;
                const subdomainCount = primaryCandidate.subdomain_count || 0;
                const dynamicCount = primaryCandidate.dynamic_count || 0;

                // åŠ¨æ€å½’ä¸€åŒ–åŸºæ•°ï¼šæœ‰åŒ…ååŒ¹é…æ—¶ä¸º40ï¼Œæ— åŒ…ååŒ¹é…æ—¶ä¸º25
                const hasPackageMatch = parseFloat(packageScore) > 0;
                const normalizeBase = hasPackageMatch ? 40 : 25;

                const tooltipContent = `
                    <div class="domain-tooltip-content">
                        <div class="tooltip-row">
                            <span class="tooltip-label">æ€»åˆ†:</span>
                            <span class="tooltip-value score-highlight">${totalScore}/${normalizeBase}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">ç½®ä¿¡åº¦:</span>
                            <span class="tooltip-value">${confidence}%</span>
                        </div>
                        <div style="border-top: 1px solid rgba(255,255,255,0.2); margin: 6px 0; padding-top: 6px;"></div>
                        ${packageScore > 0 ? `<div class="tooltip-row"><span class="tooltip-label" style="color: #60A5FA;">âœ“ åŒ…ååŒ¹é…</span><span class="tooltip-value">+${packageScore}</span></div>` : ''}
                        <div class="tooltip-row">
                            <span class="tooltip-label">URLé¢‘ç‡ (${primaryCandidate.request_count})</span>
                            <span class="tooltip-value">+${frequencyScore}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">è·¯å¾„å¤šæ ·æ€§ (${pathCount})</span>
                            <span class="tooltip-value">+${pathScore}</span>
                        </div>
                        <div class="tooltip-row">
                            <span class="tooltip-label">å­åŸŸåæ•°é‡ (${subdomainCount})</span>
                            <span class="tooltip-value">+${subdomainScore}</span>
                        </div>
                        ${primaryCandidate.is_api ? `<div class="tooltip-row"><span class="tooltip-label" style="color: #60A5FA;">âœ“ APIç‰¹å¾</span><span class="tooltip-value">+${apiScore}</span></div>` : ''}
                        ${primaryCandidate.has_auth ? `<div class="tooltip-row"><span class="tooltip-label" style="color: #60A5FA;">âœ“ è®¤è¯ç‰¹å¾</span><span class="tooltip-value">+${authScore}</span></div>` : ''}
                        ${primaryCandidate.is_cdn ? `<div class="tooltip-row"><span class="tooltip-label" style="color: #F59E0B;">âš  CDNåŸŸå</span><span class="tooltip-value">${cdnPenalty}</span></div>` : ''}
                        ${primaryCandidate.is_sdk ? `<div class="tooltip-row"><span class="tooltip-label" style="color: #DC2626;">âœ— SDKåŸŸå</span><span class="tooltip-value">${sdkPenalty}</span></div>` : ''}
                    </div>
                `;
                domainHtml = `<span class="domain-tooltip">${domain}${tooltipContent}</span> <span style="color: #10B981; font-size: 11px; font-weight: 600;">(${confidence}%)</span>`;
            }

            // ç»Ÿè®¡æ‰€æœ‰åŸŸåæ•°é‡
            const appDomains = task.app_domains || [];
            const directIPs = task.url_direct_ips || [];
            const totalDomains = appDomains.length + directIPs.length;

            let html = `<div><strong>${domainHtml}</strong>`;

            // æ˜¾ç¤ºä¸»åŸŸåå½’å±åœ°ï¼ˆç®€åŒ–æ˜¾ç¤ºï¼‰
            if (appDomains.length > 0) {
                // æ‰¾åˆ°ä¸»åŸŸåå¯¹åº”çš„å½’å±åœ°ä¿¡æ¯
                const mainDomainInfo = appDomains.find(d => d.domain === domain);
                if (mainDomainInfo) {
                    const locationParts = [];
                    if (mainDomainInfo.province) locationParts.push(mainDomainInfo.province);
                    if (mainDomainInfo.isp) locationParts.push(mainDomainInfo.isp);
                    if (locationParts.length > 0) {
                        html += `<div style="font-size: 11px; color: #64748B; margin-top: 2px;">ğŸ“ ${locationParts.join('Â·')}</div>`;
                    }
                }
            }

            // åªè¦æœ‰åŸŸåæˆ–IPæ•°æ®ï¼Œå°±æ˜¾ç¤ºæŸ¥çœ‹è¯¦æƒ…é“¾æ¥
            if (totalDomains > 0) {
                const otherDomainsCount = totalDomains - 1; // å‡å»ä¸»åŸŸå
                if (otherDomainsCount > 0) {
                    // æœ‰å…¶ä»–åŸŸåï¼šæ˜¾ç¤ºæ•°é‡
                    html += `<div style="font-size: 11px; color: #3B82F6; margin-top: 4px; cursor: pointer;" onclick="showDomainDetailsModal('${task.id}', event)">
                        <span style="font-weight: 600;">+${otherDomainsCount}ä¸ªåŸŸå</span> <span style="color: #94A3B8;">ç‚¹å‡»æŸ¥çœ‹</span>
                    </div>`;
                } else {
                    // åªæœ‰ä¸»åŸŸåï¼šæ˜¾ç¤º"æŸ¥çœ‹è¯¦æƒ…"
                    html += `<div style="font-size: 11px; color: #3B82F6; margin-top: 4px; cursor: pointer;" onclick="showDomainDetailsModal('${task.id}', event)">
                        <span style="font-weight: 600;">æŸ¥çœ‹å½’å±åœ°è¯¦æƒ…</span>
                    </div>`;
                }
            }

            html += '</div>';
            return html;
        }

        // æ˜¾ç¤ºåŸŸåè¯¦æƒ…Modal
        function showDomainDetailsModal(taskId, event) {
            event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¡Œç‚¹å‡»

            // ä»å½“å‰ä»»åŠ¡åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„ä»»åŠ¡
            const task = window.currentTasks?.find(t => t.id === taskId);
            if (!task) {
                alert('æ— æ³•è·å–ä»»åŠ¡è¯¦æƒ…');
                return;
            }

            // æ„å»ºåŸŸåè¯¦æƒ…è¡¨æ ¼
            let modalContent = `
                <div class="modal-overlay" onclick="closeDomainModal()">
                    <div class="modal-content domain-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>åŸŸåå½’å±åœ°è¯¦æƒ…</h3>
                            <button class="modal-close" onclick="closeDomainModal()">âœ•</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 12px; color: #64748B;">
                                <strong>APK:</strong> ${task.apk_name || 'N/A'}
                            </div>
                            <table class="domain-details-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">æ ‡è®°</th>
                                        <th style="width: 200px;">åŸŸå/IP</th>
                                        <th>IPåœ°å€</th>
                                        <th>çœä»½</th>
                                        <th>åŸå¸‚</th>
                                        <th>ISP</th>
                                        <th style="width: 100px;">æ¥æº</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            // è§£æä¸»åŸŸå
            let primaryDomain = 'N/A';
            if (task.primary_domain) {
                try {
                    const domainData = JSON.parse(task.primary_domain);
                    primaryDomain = domainData.primary_domain || 'N/A';
                } catch {}
            }

            // æ ¼å¼åŒ–æ¥æºæ ‡ç­¾
            function formatSource(source) {
                if (!source) return '<span style="color: #94A3B8;">-</span>';
                if (source.startsWith('app_server')) {
                    // åº”ç”¨æœåŠ¡å™¨åˆ†ç±»æ¥æº
                    let dnsType = '';
                    if (source.includes('telecom')) dnsType = 'ç”µä¿¡';
                    else if (source.includes('mobile')) dnsType = 'ç§»åŠ¨';
                    return `<span style="background: #DCFCE7; color: #16A34A; padding: 2px 6px; border-radius: 4px; font-size: 11px;">åº”ç”¨æœåŠ¡å™¨${dnsType ? 'Â·' + dnsType : ''}</span>`;
                } else if (source === 'telecom' || source === 'local') {
                    return '<span style="background: #DBEAFE; color: #1E40AF; padding: 2px 6px; border-radius: 4px; font-size: 11px;">ç”µä¿¡DNS</span>';
                } else if (source === 'mobile' || source === 'remote') {
                    return '<span style="background: #FEF3C7; color: #D97706; padding: 2px 6px; border-radius: 4px; font-size: 11px;">ç§»åŠ¨DNS</span>';
                } else if (source === 'unknown') {
                    return '<span style="color: #94A3B8; font-size: 11px;">æœªçŸ¥</span>';
                }
                return `<span style="color: #64748B; font-size: 11px;">${source}</span>`;
            }

            // æ·»åŠ åº”ç”¨åŸŸå
            if (task.app_domains && Array.isArray(task.app_domains)) {
                task.app_domains.forEach((domainItem, index) => {
                    const isPrimary = domainItem.domain === primaryDomain;
                    const isAppServer = domainItem.source && domainItem.source.startsWith('app_server');
                    const marker = isPrimary ? 'â­' : (isAppServer ? 'ğŸ ' : '');
                    modalContent += `
                        <tr${isAppServer ? ' style="background: #F0FDF4;"' : ''}>
                            <td style="text-align: center;">${marker}</td>
                            <td><code style="font-size: 12px;">${domainItem.domain || 'N/A'}</code></td>
                            <td><code style="font-size: 11px; color: #64748B;">${domainItem.ip || 'N/A'}</code></td>
                            <td>${domainItem.province || '-'}</td>
                            <td>${domainItem.city || '-'}</td>
                            <td><span style="color: #3B82F6; font-weight: 500;">${domainItem.isp || '-'}</span></td>
                            <td>${formatSource(domainItem.source)}</td>
                        </tr>
                    `;
                });
            }

            // æ·»åŠ ç›´è¿IP
            if (task.url_direct_ips && Array.isArray(task.url_direct_ips)) {
                task.url_direct_ips.forEach(ipItem => {
                    const ip = typeof ipItem === 'string' ? ipItem : ipItem.ip;
                    const province = typeof ipItem === 'object' ? (ipItem.province || '-') : '-';
                    const city = typeof ipItem === 'object' ? (ipItem.city || '-') : '-';
                    const isp = typeof ipItem === 'object' ? (ipItem.isp || '-') : '-';

                    modalContent += `
                        <tr style="background: #FEF2F2;">
                            <td style="text-align: center;">ğŸ“</td>
                            <td><code style="font-size: 12px; color: #DC2626;">ç›´è¿IP</code></td>
                            <td><code style="font-size: 11px; color: #DC2626; font-weight: 600;">${ip}</code></td>
                            <td>${province}</td>
                            <td>${city}</td>
                            <td><span style="color: #DC2626; font-weight: 500;">${isp}</span></td>
                            <td><span style="background: #FEE2E2; color: #DC2626; padding: 2px 6px; border-radius: 4px; font-size: 11px;">ç¡¬ç¼–ç IP</span></td>
                        </tr>
                    `;
                });
            }

            modalContent += `
                                </tbody>
                            </table>
                            <div style="margin-top: 12px; padding: 8px; background: #F1F5F9; border-radius: 6px; font-size: 12px; color: #64748B;">
                                ğŸ’¡ è¯´æ˜: â­ ä¸»åŸŸå | ğŸ  åº”ç”¨æœåŠ¡å™¨ï¼ˆURLåˆ†ç±»è¯†åˆ«ï¼‰| ğŸ“ ç¡¬ç¼–ç IPåœ°å€
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ’å…¥åˆ°é¡µé¢
            const modalDiv = document.createElement('div');
            modalDiv.id = 'domain-modal';
            modalDiv.innerHTML = modalContent;
            document.body.appendChild(modalDiv);
        }

        // å…³é—­Modal
        function closeDomainModal() {
            const modal = document.getElementById('domain-modal');
            if (modal) {
                modal.remove();
            }
        }

        function formatBeian(beianJson) {
            // å¦‚æœ beianJson æ˜¯ undefined æˆ– nullï¼Œè¯´æ˜ä»»åŠ¡å¤±è´¥åœ¨åŸŸååˆ†æä¹‹å‰ï¼Œè¿”å› N/A
            if (beianJson === undefined || beianJson === null) return 'N/A';
            // å¦‚æœ beianJson æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œè¯´æ˜åŸŸååˆ†æå®Œæˆä½†æ— å¤‡æ¡ˆä¿¡æ¯
            if (!beianJson) return '<span style="color: #94A3B8;">æœªæŸ¥è¯¢</span>';
            try {
                const data = JSON.parse(beianJson);
                if (Array.isArray(data) && data.length > 0) {
                    const result = data[0];
                    // æ£€æŸ¥é¡¶å±‚çš„ status å­—æ®µ
                    // 1. status = 'registered' è¡¨ç¤ºå·²å¤‡æ¡ˆ
                    if (result.status === 'registered') {
                        const beianNumber = result.beian_number || result.info?.service_licence;
                        const companyName = result.company_name || result.info?.unit_name;
                        const tooltip = beianNumber ? `å¤‡æ¡ˆå·: ${beianNumber}${companyName ? '\nå•ä½: ' + companyName : ''}` : '';
                        return `<span style="color: #16A34A;" title="${tooltip}">âœ… å·²å¤‡æ¡ˆ</span>`;
                    }
                    // 2. status = 'error' è¡¨ç¤ºæŸ¥è¯¢å¤±è´¥æˆ–æœªå¤‡æ¡ˆ
                    else if (result.status === 'error') {
                        const reason = result.info?.reason || result.error;
                        if (reason && reason.includes('æš‚æ— æ•°æ®')) {
                            return '<span style="color: #F59E0B;">âš ï¸ æœªå¤‡æ¡ˆ</span>';
                        }
                        return '<span style="color: #DC2626;">âœ— æŸ¥è¯¢å¤±è´¥</span>';
                    }
                    // 3. å…¼å®¹æ—§æ ¼å¼: beian_info.status
                    else if (result.beian_info?.status === 'registered') {
                        return '<span style="color: #16A34A;">âœ… å·²å¤‡æ¡ˆ</span>';
                    }
                }
                return '<span style="color: #94A3B8;">æœªæŸ¥è¯¢</span>';
            } catch (e) {
                console.error('Failed to parse beian JSON:', e);
                return '<span style="color: #94A3B8;">è§£æé”™è¯¯</span>';
            }
        }

        function formatStaticAnalysis(task) {
            const status = task.static_status;

            // æ ¹æ®é™æ€åˆ†æçŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹
            if (status === 'completed') {
                // é™æ€åˆ†æå®Œæˆï¼Œæ˜¾ç¤ºå¯ç‚¹å‡»çš„"é™æ€åˆ†æ"é“¾æ¥
                return `<a href="/api/tasks/${task.id}/static/report" target="_blank" class="static-analysis-link">é™æ€åˆ†æ</a>`;
            } else if (status === 'analyzing' || status === 'queued') {
                // æ­£åœ¨åˆ†æä¸­
                return '<span style="color: #2563EB;">â³ åˆ†æä¸­...</span>';
            } else if (status === 'failed') {
                // åˆ†æå¤±è´¥
                return '<span style="color: #DC2626;">âœ— å¤±è´¥</span>';
            } else {
                // å…¶ä»–æƒ…å†µæ˜¾ç¤º N/A
                return '<span style="color: #94A3B8;">N/A</span>';
            }
        }

        function refreshTasks() {
            loadTasks();
            loadStats();
        }

        function viewTask(taskId) {
            window.open(`/tasks/${taskId}`, '_blank');
        }

        function viewActivities(taskId) {
            window.open(`/api/tasks/${taskId}/activities/report`, '_blank');
        }

        function viewURLs(taskId) {
            window.open(`/tasks/${taskId}/urls`, '_blank');
        }

        async function deleteTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('ä»»åŠ¡åˆ é™¤æˆåŠŸ');
                    loadTasks();
                } else {
                    alert('åˆ é™¤ä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to delete task:', error);
                alert('åˆ é™¤ä»»åŠ¡å¤±è´¥');
            }
        }

        function showUploadDialog() {
            document.getElementById('upload-modal').style.display = 'flex';
        }

        function closeUploadDialog() {
            document.getElementById('upload-modal').style.display = 'none';
            document.getElementById('apk-file-input').value = '';
            document.getElementById('upload-progress').style.display = 'none';
            document.getElementById('upload-progress-bar').style.width = '0%';
            document.getElementById('upload-progress-text').textContent = '0%';
            document.getElementById('selected-files-container').style.display = 'none';
            document.getElementById('selected-files-list').innerHTML = '';
            document.getElementById('selected-files-count').textContent = '0';
            document.getElementById('upload-results').style.display = 'none';
            document.getElementById('upload-results-list').innerHTML = '';
            document.getElementById('upload-btn').disabled = false;
            document.getElementById('upload-btn').textContent = 'ğŸ“¤ å¼€å§‹ä¸Šä¼ ';
        }

        function updateFileList() {
            const fileInput = document.getElementById('apk-file-input');
            const files = fileInput.files;
            const container = document.getElementById('selected-files-container');
            const list = document.getElementById('selected-files-list');
            const count = document.getElementById('selected-files-count');

            if (files.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            count.textContent = files.length;

            let html = '';
            const maxSize = 500 * 1024 * 1024; // 500MB

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
                const isValid = file.name.toLowerCase().endsWith('.apk') && file.size <= maxSize;
                const statusIcon = isValid ? 'âœ“' : 'âœ—';
                const statusColor = isValid ? '#10B981' : '#EF4444';
                const errorMsg = !file.name.toLowerCase().endsWith('.apk') ? '(éAPKæ–‡ä»¶)' :
                                 file.size > maxSize ? '(è¶…è¿‡500MB)' : '';

                html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 6px; margin-bottom: 4px;">
                    <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                        <span style="color: ${statusColor}; font-weight: bold;">${statusIcon}</span>
                        <span style="font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${file.name}</span>
                        <span style="color: #EF4444; font-size: 11px;">${errorMsg}</span>
                    </div>
                    <span style="font-size: 12px; color: #64748B; white-space: nowrap;">${sizeInMB} MB</span>
                </div>`;
            }
            list.innerHTML = html;
        }

        function clearFileSelection() {
            document.getElementById('apk-file-input').value = '';
            document.getElementById('selected-files-container').style.display = 'none';
            document.getElementById('selected-files-list').innerHTML = '';
            document.getElementById('selected-files-count').textContent = '0';
        }

        async function uploadAPK() {
            const fileInput = document.getElementById('apk-file-input');
            const files = fileInput.files;

            if (files.length === 0) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„ APK æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶æ•°é‡é™åˆ¶
            if (files.length > 100) {
                alert('æœ€å¤šåŒæ—¶ä¸Šä¼  100 ä¸ªæ–‡ä»¶');
                return;
            }

            // éªŒè¯æ‰€æœ‰æ–‡ä»¶
            const maxSize = 500 * 1024 * 1024; // 500MB
            let validFiles = [];
            let invalidFiles = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.name.toLowerCase().endsWith('.apk')) {
                    invalidFiles.push(`${file.name} (éAPKæ–‡ä»¶)`);
                } else if (file.size > maxSize) {
                    invalidFiles.push(`${file.name} (è¶…è¿‡500MB)`);
                } else {
                    validFiles.push(file);
                }
            }

            if (validFiles.length === 0) {
                alert('æ²¡æœ‰æœ‰æ•ˆçš„ APK æ–‡ä»¶å¯ä¸Šä¼ :\n' + invalidFiles.join('\n'));
                return;
            }

            // å¦‚æœæœ‰æ— æ•ˆæ–‡ä»¶ï¼Œæç¤ºç”¨æˆ·
            if (invalidFiles.length > 0) {
                const proceed = confirm(`ä»¥ä¸‹æ–‡ä»¶å°†è¢«è·³è¿‡:\n${invalidFiles.join('\n')}\n\næ˜¯å¦ç»§ç»­ä¸Šä¼  ${validFiles.length} ä¸ªæœ‰æ•ˆæ–‡ä»¶?`);
                if (!proceed) return;
            }

            const formData = new FormData();
            // æ‰¹é‡ä¸Šä¼ ä½¿ç”¨ 'files' å­—æ®µå
            if (validFiles.length === 1) {
                formData.append('file', validFiles[0]);
            } else {
                for (let i = 0; i < validFiles.length; i++) {
                    formData.append('files', validFiles[i]);
                }
            }

            const progressBar = document.getElementById('upload-progress-bar');
            const progressText = document.getElementById('upload-progress-text');
            const progressContainer = document.getElementById('upload-progress');
            const uploadBtn = document.getElementById('upload-btn');
            const resultsContainer = document.getElementById('upload-results');
            const resultsList = document.getElementById('upload-results-list');

            try {
                progressContainer.style.display = 'block';
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';

                const xhr = new XMLHttpRequest();

                // ä¸Šä¼ è¿›åº¦ç›‘å¬
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressText.textContent = percent + '%';
                    }
                });

                // å®Œæˆç›‘å¬
                xhr.addEventListener('load', () => {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'ğŸ“¤ å¼€å§‹ä¸Šä¼ ';

                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);

                        // å•æ–‡ä»¶ä¸Šä¼ 
                        if (response.filename) {
                            alert(`ä¸Šä¼ æˆåŠŸï¼\næ–‡ä»¶å: ${response.filename}\nå¤§å°: ${(response.size / 1024 / 1024).toFixed(2)} MB`);
                            closeUploadDialog();
                            loadTasks();
                            return;
                        }

                        // æ‰¹é‡ä¸Šä¼ ç»“æœ
                        resultsContainer.style.display = 'block';
                        let resultsHTML = `<div style="margin-bottom: 10px; padding: 10px; background: #DCFCE7; border-radius: 6px; color: #166534;">
                            ${response.message}
                        </div>`;

                        if (response.results) {
                            for (const result of response.results) {
                                const statusIcon = result.status === 'success' ? 'âœ“' :
                                                   result.status === 'skipped' ? 'âŠ˜' : 'âœ—';
                                const bgColor = result.status === 'success' ? '#DCFCE7' :
                                                result.status === 'skipped' ? '#FEF3C7' : '#FEE2E2';
                                const textColor = result.status === 'success' ? '#166534' :
                                                  result.status === 'skipped' ? '#92400E' : '#DC2626';
                                const statusText = result.status === 'success' ? 'æˆåŠŸ' :
                                                   result.status === 'skipped' ? 'è·³è¿‡' : 'å¤±è´¥';

                                resultsHTML += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: ${bgColor}; border-radius: 6px; margin-bottom: 4px;">
                                    <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                                        <span style="color: ${textColor}; font-weight: bold;">${statusIcon}</span>
                                        <span style="font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${result.filename}">${result.filename}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        ${result.error ? `<span style="font-size: 11px; color: ${textColor};">${result.error}</span>` : ''}
                                        <span style="font-size: 12px; color: ${textColor}; font-weight: 500;">${statusText}</span>
                                    </div>
                                </div>`;
                            }
                        }
                        resultsList.innerHTML = resultsHTML;

                        // å¦‚æœæœ‰æˆåŠŸçš„ï¼Œ5ç§’ååˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                        if (response.success_count > 0) {
                            setTimeout(() => {
                                loadTasks();
                            }, 2000);
                        }
                    } else if (xhr.status === 409) {
                        const response = JSON.parse(xhr.responseText);
                        alert(`ä¸Šä¼ å¤±è´¥: ${response.error}\næ–‡ä»¶å·²å­˜åœ¨`);
                    } else {
                        const response = JSON.parse(xhr.responseText);
                        alert(`ä¸Šä¼ å¤±è´¥: ${response.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    progressBar.style.width = '0%';
                    progressText.textContent = '0%';
                });

                // é”™è¯¯ç›‘å¬
                xhr.addEventListener('error', () => {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'ğŸ“¤ å¼€å§‹ä¸Šä¼ ';
                    alert('ä¸Šä¼ å¤±è´¥: ç½‘ç»œé”™è¯¯');
                    progressBar.style.width = '0%';
                    progressText.textContent = '0%';
                });

                // æ ¹æ®æ–‡ä»¶æ•°é‡é€‰æ‹©API
                const apiUrl = validFiles.length === 1 ? '/api/upload' : '/api/upload/batch';
                xhr.open('POST', apiUrl);
                xhr.send(formData);
            } catch (error) {
                console.error('Upload failed:', error);
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ğŸ“¤ å¼€å§‹ä¸Šä¼ ';
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
            }
        }

        // è·å–å½“å‰ç­›é€‰æ¡ä»¶æè¿°
        function getFilterDescription() {
            const parts = [];
            const province = document.getElementById('province-filter').value;
            const isp = document.getElementById('isp-filter').value;
            const beian = document.getElementById('beian-filter').value;
            const search = document.getElementById('search-input').value.trim();

            if (province) parts.push(province);
            if (isp) parts.push(isp);
            if (beian) parts.push(beian);
            if (search) parts.push(`æœç´¢"${search}"`);

            return parts.length > 0 ? parts.join('_') : 'å…¨éƒ¨';
        }

        // æ›´æ–°å¯¼å‡ºæŒ‰é’®æ–‡æ¡ˆ
        function updateExportButtonText() {
            const btn = document.getElementById('export-btn');
            if (!btn) return;

            const province = document.getElementById('province-filter').value;
            const isp = document.getElementById('isp-filter').value;
            const beian = document.getElementById('beian-filter').value;
            const search = document.getElementById('search-input').value.trim();

            const hasFilter = province || isp || beian || search;
            btn.textContent = hasFilter ? 'ğŸ“¥ å¯¼å‡ºç­›é€‰ç»“æœ' : 'ğŸ“¥ å¯¼å‡ºå…¨éƒ¨';
        }

        // è·å–å¤‡æ¡ˆçŠ¶æ€æ–‡æœ¬ï¼ˆä¸é¡µé¢ formatBeian() é€»è¾‘ä¿æŒä¸€è‡´ï¼‰
        function getBeianStatusText(task) {
            if (!task.domain_beian_status) return 'æœªæŸ¥è¯¢';

            try {
                const data = JSON.parse(task.domain_beian_status);
                if (Array.isArray(data) && data.length > 0) {
                    const result = data[0];
                    // 1. status = 'registered' è¡¨ç¤ºå·²å¤‡æ¡ˆ
                    if (result.status === 'registered') {
                        return 'å·²å¤‡æ¡ˆ';
                    }
                    // 2. status = 'error' è¡¨ç¤ºæŸ¥è¯¢å¤±è´¥æˆ–æœªå¤‡æ¡ˆ
                    else if (result.status === 'error') {
                        const reason = result.info?.reason || result.error;
                        if (reason && reason.includes('æš‚æ— æ•°æ®')) {
                            return 'æœªå¤‡æ¡ˆ';
                        }
                        return 'æŸ¥è¯¢å¤±è´¥';
                    }
                    // 3. å…¼å®¹æ—§æ ¼å¼: beian_info.status
                    else if (result.beian_info?.status === 'registered') {
                        return 'å·²å¤‡æ¡ˆ';
                    }
                }
                return 'æœªæŸ¥è¯¢';
            } catch (e) {
                return 'è§£æé”™è¯¯';
            }
        }

        // å¯¼å‡ºç­›é€‰ç»“æœï¼ˆç»“åˆæ‰€æœ‰ç­›é€‰æ¡ä»¶ï¼‰
        async function exportFilteredTasks() {
            try {
                // è·å–å½“å‰ç­›é€‰æ¡ä»¶
                const province = document.getElementById('province-filter').value;
                const isp = document.getElementById('isp-filter').value;
                const beian = document.getElementById('beian-filter').value;
                const search = document.getElementById('search-input').value.trim();

                // æ„å»º API è¯·æ±‚å‚æ•°ï¼ˆä½¿ç”¨å¯¼å‡ºä¸“ç”¨æ¥å£ï¼Œä¸åˆ†é¡µï¼‰
                let url = '/api/tasks/export?status=completed';
                if (province) url += `&province=${encodeURIComponent(province)}`;
                if (isp) url += `&isp=${encodeURIComponent(isp)}`;
                if (beian) url += `&beian_status=${encodeURIComponent(beian)}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const response = await fetch(url);
                const data = await response.json();

                if (!data.tasks || data.tasks.length === 0) {
                    alert('æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä»»åŠ¡');
                    return;
                }

                // æ„å»ºå¯¼å‡ºæ•°æ®
                const rows = [];
                const today = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });

                for (const task of data.tasks) {
                    // è·å–åº”ç”¨åç§°å’Œå¤‡æ¡ˆçŠ¶æ€
                    const appName = task.static_report?.app_name || task.apk_name?.replace('.apk', '') || '';
                    const packageName = task.package_name || '';
                    const beianStatus = getBeianStatusText(task);

                    // å¤„ç†åŸŸååˆ—è¡¨
                    if (task.app_domains && task.app_domains.length > 0) {
                        let hasMatchedDomain = false;
                        for (const domainInfo of task.app_domains) {
                            // å¦‚æœæœ‰çœä»½ç­›é€‰ï¼Œè¿‡æ»¤ä¸åŒ¹é…çš„åŸŸå
                            if (province && domainInfo.province && !domainInfo.province.includes(province)) {
                                continue;
                            }
                            // å¦‚æœæœ‰ ISP ç­›é€‰ï¼Œè¿‡æ»¤ä¸åŒ¹é…çš„åŸŸå
                            if (isp && domainInfo.isp && !domainInfo.isp.includes(isp)) {
                                continue;
                            }

                            rows.push([
                                appName,
                                packageName,
                                domainInfo.domain || '',
                                domainInfo.ip || '',
                                domainInfo.province || '',
                                domainInfo.isp || '',
                                beianStatus,
                                today
                            ]);
                            hasMatchedDomain = true;
                        }

                        // å¦‚æœè¯¥ä»»åŠ¡çš„æ‰€æœ‰åŸŸåéƒ½è¢«è¿‡æ»¤æ‰äº†ï¼Œä½†ä»»åŠ¡æœ¬èº«ç¬¦åˆæ¡ä»¶ï¼Œä»ç„¶æ·»åŠ ä¸€æ¡è®°å½•
                        if (!hasMatchedDomain) {
                            rows.push([
                                appName,
                                packageName,
                                '',
                                '',
                                '',
                                '',
                                beianStatus,
                                today
                            ]);
                        }
                    } else {
                        // æ²¡æœ‰åŸŸåä¿¡æ¯çš„æƒ…å†µ
                        rows.push([
                            appName,
                            packageName,
                            '',
                            '',
                            '',
                            '',
                            beianStatus,
                            today
                        ]);
                    }
                }

                if (rows.length === 0) {
                    alert('æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®');
                    return;
                }

                // ç”Ÿæˆ Excel æ–‡ä»¶ (ä½¿ç”¨ SheetJS)
                const headers = ['APPåç§°', 'åŒ…å', 'æ¥å…¥åŸŸå', 'æ¥å…¥IP', 'å½’å±åœ°', 'è¿è¥å•†', 'å¤‡æ¡ˆçŠ¶æ€', 'å‘ç°æ—¶é—´'];

                // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
                const wb = XLSX.utils.book_new();
                const wsData = [headers, ...rows];
                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // è®¾ç½®åˆ—å®½
                ws['!cols'] = [
                    { wch: 25 },  // APPåç§°
                    { wch: 35 },  // åŒ…å
                    { wch: 30 },  // æ¥å…¥åŸŸå
                    { wch: 18 },  // æ¥å…¥IP
                    { wch: 15 },  // å½’å±åœ°
                    { wch: 12 },  // è¿è¥å•†
                    { wch: 10 },  // å¤‡æ¡ˆçŠ¶æ€
                    { wch: 15 }   // å‘ç°æ—¶é—´
                ];

                // ç”Ÿæˆå·¥ä½œè¡¨åç§°å’Œæ–‡ä»¶å
                const filterDesc = getFilterDescription();
                const sheetName = filterDesc.length > 31 ? filterDesc.substring(0, 31) : filterDesc;  // Excel å·¥ä½œè¡¨åæœ€é•¿ 31 å­—ç¬¦
                XLSX.utils.book_append_sheet(wb, ws, sheetName);

                // å¯¼å‡ºæ–‡ä»¶
                const filename = `APPåˆ†æ_${filterDesc}_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, filename);

                alert(`æˆåŠŸå¯¼å‡º ${rows.length} æ¡è®°å½•`);
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // Dashboardç›¸å…³å‡½æ•°
        async function loadDashboard() {
            await Promise.all([
                loadDevices(),
                loadDashboardSDKCount(),
                loadRecentTasks()
            ]);
        }

        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                const data = await response.json();

                // æ›´æ–°è®¾å¤‡çŠ¶æ€å¡ç‰‡
                document.getElementById('devices-available').textContent =
                    `${data.available} / ${data.total_devices}`;

                const badge = document.getElementById('devices-status-badge');
                // åªè¦è®¾å¤‡æ€»æ•° > 0ï¼Œå°±è¡¨ç¤ºè®¾å¤‡åœ¨çº¿ï¼ˆæ— è®ºæ˜¯å¦å¯ç”¨ï¼‰
                if (data.total_devices > 0) {
                    if (data.available > 0) {
                        badge.textContent = 'âœ“ åœ¨çº¿';
                        badge.style.background = '#DCFCE7';
                        badge.style.color = '#16A34A';
                    } else {
                        // è®¾å¤‡éƒ½åœ¨ä½¿ç”¨ä¸­ï¼Œæ˜¾ç¤º"ç¹å¿™"è€Œä¸æ˜¯"ç¦»çº¿"
                        badge.textContent = 'âš™ï¸ ç¹å¿™';
                        badge.style.background = '#DBEAFE';
                        badge.style.color = '#2563EB';
                    }
                } else {
                    badge.textContent = 'âœ— ç¦»çº¿';
                    badge.style.background = '#FEE2E2';
                    badge.style.color = '#DC2626';
                }

                // æ¸²æŸ“è®¾å¤‡å¡ç‰‡
                const devicesGrid = document.getElementById('devices-grid');
                devicesGrid.innerHTML = data.devices.map(device => `
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">${device.id}</div>
                            <div class="stat-trend" style="background: ${device.in_use ? '#DBEAFE' : '#DCFCE7'}; color: ${device.in_use ? '#2563EB' : '#16A34A'};">
                                ${device.in_use ? 'âš™ï¸ ä½¿ç”¨ä¸­' : 'âœ“ ç©ºé—²'}
                            </div>
                        </div>
                        <div style="font-size: 14px; color: #64748B; margin-top: 8px;">
                            <div><strong>ADB:</strong> ${device.adb_target}</div>
                            ${device.task_id ? `<div style="margin-top: 4px;"><strong>ä»»åŠ¡:</strong> ${device.task_id.substring(0, 8)}...</div>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load devices:', error);
            }
        }

        async function loadDashboardSDKCount() {
            try {
                // å…ˆç›´æ¥è®¾ç½®ä¸ºå›ºå®šå€¼ 211ï¼ˆä»ä¹‹å‰çš„æŸ¥è¯¢å¾—çŸ¥ï¼‰
                document.getElementById('sdk-rules-count').textContent = '211';
            } catch (error) {
                console.error('Failed to load SDK count:', error);
            }
        }

        async function loadRecentTasks() {
            try {
                const response = await fetch('/api/tasks?page=1&page_size=5');
                const data = await response.json();

                const tasks = data.tasks || data || [];
                const tbody = document.getElementById('dashboard-recent-tasks');

                if (tasks.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #64748B;">
                                æš‚æ— æœ€è¿‘ä»»åŠ¡
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = tasks.map(task => `
                    <tr>
                        <td><strong>${task.apk_name || 'N/A'}</strong></td>
                        <td style="color: #64748B; font-size: 13px;">${task.package_name || 'N/A'}</td>
                        <td><span class="status-badge status-${task.status}">${formatStatus(task.status)}</span></td>
                        <td>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${task.progress_percent || 0}%"></div>
                            </div>
                            <div class="progress-text">${task.progress_percent || 0}%</div>
                        </td>
                        <td>${formatStaticAnalysis(task)}</td>
                        <td style="font-size: 13px; color: #64748B;">${formatDate(task.created_at)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load recent tasks:', error);
            }
        }

        function refreshDashboard() {
            loadDashboard();
            loadStats();
        }

        let dashboardRefreshInterval = null;

        function showSection(section) {
            // æ›´æ–°ä¾§è¾¹æ æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.sidebar-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹åŒºåŸŸ
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('inventory-section').style.display = 'none';
            document.getElementById('sdk-rules-section').style.display = 'none';

            // æ¸…é™¤ä¹‹å‰çš„è‡ªåŠ¨åˆ·æ–°
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
                dashboardRefreshInterval = null;
            }

            // æ§åˆ¶ä¸»é¡µé¢å¤´éƒ¨å’Œç»Ÿè®¡å¡ç‰‡çš„æ˜¾ç¤º
            const mainHeader = document.getElementById('main-header');
            const mainStatsGrid = document.getElementById('main-stats-grid');

            if (section === 'dashboard') {
                mainHeader.style.display = 'flex';
                mainStatsGrid.style.display = 'grid';
                document.getElementById('dashboard-section').style.display = 'block';
                loadDashboard();
                // æ¯ 5 ç§’è‡ªåŠ¨åˆ·æ–° Dashboard
                dashboardRefreshInterval = setInterval(loadDashboard, 5000);
            } else if (section === 'inventory') {
                // ä»»åŠ¡åˆ—è¡¨é¡µé¢ï¼šéšè—ä¸»é¡µé¢çš„å¤´éƒ¨å’Œç»Ÿè®¡å¡ç‰‡
                mainHeader.style.display = 'none';
                mainStatsGrid.style.display = 'none';
                document.getElementById('inventory-section').style.display = 'block';
            } else if (section === 'sdk-rules') {
                // SDKè§„åˆ™é¡µé¢ï¼šéšè—ä¸»é¡µé¢çš„å¤´éƒ¨å’Œç»Ÿè®¡å¡ç‰‡
                mainHeader.style.display = 'none';
                mainStatsGrid.style.display = 'none';
                document.getElementById('sdk-rules-section').style.display = 'block';
                loadSDKRules();
            }
        }

        // Queue Management Modal Functions
        async function showQueueModal() {
            const modal = document.getElementById('queue-modal');
            modal.style.display = 'flex';

            // Load queued tasks
            await loadQueueTasks();
        }

        function closeQueueModal() {
            const modal = document.getElementById('queue-modal');
            modal.style.display = 'none';
        }

        // AI Interaction Modal functions
        function showAIInteractionModal() {
            const modal = document.getElementById('ai-interaction-modal');
            const iframe = document.getElementById('ai-interaction-iframe');
            iframe.src = '/ai-interaction';
            modal.style.display = 'flex';
        }

        function closeAIInteractionModal() {
            const modal = document.getElementById('ai-interaction-modal');
            const iframe = document.getElementById('ai-interaction-iframe');
            iframe.src = '';  // Stop loading/websocket
            modal.style.display = 'none';
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('queue-modal');
            if (event.target === modal) {
                closeQueueModal();
            }
            const aiModal = document.getElementById('ai-interaction-modal');
            if (event.target === aiModal) {
                closeAIInteractionModal();
            }
        });

        async function loadQueueTasks() {
            try {
                // é˜Ÿåˆ—ç®¡ç†ï¼šåªè·å–æ’é˜Ÿä¸­çš„ä»»åŠ¡
                const response = await fetch('/api/tasks?page=1&page_size=1000&status=queued');
                const data = await response.json();

                const tasks = data.tasks || data || [];

                // ä»»åŠ¡å·²ç»åœ¨åç«¯è¿‡æ»¤ä¸º queued çŠ¶æ€
                const queuedTasks = tasks.filter(task => task.status === 'queued');

                // Update queue count
                document.getElementById('queue-count').textContent = queuedTasks.length;

                // Calculate average wait time
                if (queuedTasks.length > 0) {
                    const now = new Date();
                    const totalWaitMinutes = queuedTasks.reduce((sum, task) => {
                        const created = new Date(task.created_at);
                        const waitMinutes = (now - created) / (1000 * 60);
                        return sum + waitMinutes;
                    }, 0);
                    const avgWaitMinutes = Math.round(totalWaitMinutes / queuedTasks.length);

                    if (avgWaitMinutes < 60) {
                        document.getElementById('queue-avg-wait').textContent = `${avgWaitMinutes}åˆ†é’Ÿ`;
                    } else {
                        const avgWaitHours = Math.floor(avgWaitMinutes / 60);
                        const remainMinutes = avgWaitMinutes % 60;
                        document.getElementById('queue-avg-wait').textContent = `${avgWaitHours}å°æ—¶${remainMinutes}åˆ†`;
                    }
                } else {
                    document.getElementById('queue-avg-wait').textContent = '-';
                }

                // Update queue status
                if (queuedTasks.length === 0) {
                    document.getElementById('queue-status').textContent = 'ç©ºé—²';
                } else if (queuedTasks.length < 5) {
                    document.getElementById('queue-status').textContent = 'æ­£å¸¸';
                } else if (queuedTasks.length < 10) {
                    document.getElementById('queue-status').textContent = 'ç¹å¿™';
                } else {
                    document.getElementById('queue-status').textContent = 'æ‹¥å µ';
                    document.getElementById('queue-status').style.color = '#DC2626';
                }

                // Render queue tasks table
                const tbody = document.getElementById('queue-tasks-tbody');

                if (queuedTasks.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #64748B;">
                                <div style="font-size: 48px; margin-bottom: 16px;">âœ…</div>
                                <div style="font-size: 18px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">é˜Ÿåˆ—ä¸ºç©º</div>
                                <div>å½“å‰æ²¡æœ‰æ’é˜Ÿä¸­çš„ä»»åŠ¡</div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = queuedTasks.map(task => {
                    const now = new Date();
                    const created = new Date(task.created_at);
                    const waitMinutes = Math.floor((now - created) / (1000 * 60));

                    let waitTimeText;
                    if (waitMinutes < 1) {
                        waitTimeText = 'åˆšåˆš';
                    } else if (waitMinutes < 60) {
                        waitTimeText = `${waitMinutes} åˆ†é’Ÿ`;
                    } else {
                        const hours = Math.floor(waitMinutes / 60);
                        const mins = waitMinutes % 60;
                        waitTimeText = `${hours} å°æ—¶ ${mins} åˆ†é’Ÿ`;
                    }

                    return `
                        <tr style="border-bottom: 1px solid #F1F5F9;">
                            <td style="padding: 16px;"><strong>${task.apk_name || 'N/A'}</strong></td>
                            <td style="padding: 16px; color: #64748B; font-size: 13px;">${task.package_name || 'N/A'}</td>
                            <td style="padding: 16px;"><span class="status-badge status-queued">æ’é˜Ÿä¸­</span></td>
                            <td style="padding: 16px; font-size: 13px; color: #64748B;">${formatDate(task.created_at)}</td>
                            <td style="padding: 16px; font-size: 13px; color: #D97706; font-weight: 600;">${waitTimeText}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load queue tasks:', error);
                const tbody = document.getElementById('queue-tasks-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #DC2626;">
                            <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                            <div>åŠ è½½é˜Ÿåˆ—æ•°æ®å¤±è´¥</div>
                        </td>
                    </tr>
                `;
            }
        }

        // SDK Rules Management Functions
        let allSDKRules = [];
        let filteredSDKRules = [];

        async function loadSDKRules() {
            try {
                // åŠ è½½æ‰€æœ‰SDKè§„åˆ™ï¼ˆè®¾ç½®å¤§çš„limitä»¥è·å–å…¨éƒ¨æ•°æ®ï¼‰
                const response = await fetch('/api/sdk_rules?limit=1000');
                const data = await response.json();

                // Handle both array and object response formats
                allSDKRules = Array.isArray(data) ? data : (data.rules || []);

                // åŠ è½½ç»Ÿè®¡æ•°æ®ï¼ˆä½¿ç”¨ä¸“é—¨çš„ç»Ÿè®¡APIè·å–å‡†ç¡®æ•°æ®ï¼‰
                const statsResponse = await fetch('/api/sdk_rules/statistics');
                const stats = await statsResponse.json();

                // Update statistics from dedicated API
                document.getElementById('sdk-total-count').textContent = stats.total_rules || 0;
                document.getElementById('sdk-active-count').textContent = stats.active_rules || 0;
                document.getElementById('sdk-pending-count').textContent = stats.pending_rules || 0;
                document.getElementById('sdk-category-count').textContent = Object.keys(stats.by_category || {}).length;

                filterSDKRules();
            } catch (error) {
                console.error('Failed to load SDK rules:', error);
                const tbody = document.getElementById('sdk-rules-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #DC2626;">
                            <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                            <div>åŠ è½½ SDK è§„åˆ™å¤±è´¥</div>
                        </td>
                    </tr>
                `;
            }
        }

        function filterSDKRules() {
            const searchQuery = document.getElementById('sdk-search-input').value.toLowerCase();
            const categoryFilter = document.getElementById('sdk-category-filter').value;
            const statusFilter = document.getElementById('sdk-status-filter').value;

            filteredSDKRules = allSDKRules.filter(rule => {
                const matchesSearch = searchQuery === '' ||
                    rule.domain?.toLowerCase().includes(searchQuery) ||
                    rule.provider?.toLowerCase().includes(searchQuery);
                const matchesCategory = categoryFilter === '' || rule.category === categoryFilter;
                const matchesStatus = statusFilter === '' || rule.status === statusFilter;

                return matchesSearch && matchesCategory && matchesStatus;
            });

            renderSDKRules();
        }

        function renderSDKRules() {
            const tbody = document.getElementById('sdk-rules-tbody');

            if (filteredSDKRules.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“­</div>
                                <h3>æœªæ‰¾åˆ° SDK è§„åˆ™</h3>
                                <p>å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æ·»åŠ æ–°çš„è§„åˆ™</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredSDKRules.map(rule => `
                <tr>
                    <td style="font-family: monospace; font-size: 12px;">${rule.id}</td>
                    <td><strong>${rule.domain}</strong></td>
                    <td>${formatCategory(rule.category)}</td>
                    <td>${rule.provider || 'N/A'}</td>
                    <td>${(rule.confidence * 100).toFixed(0)}%</td>
                    <td><span class="status-badge status-${rule.status === 'active' ? 'completed' : rule.status === 'disabled' ? 'failed' : 'queued'}">${formatSDKStatus(rule.status)}</span></td>
                    <td>${rule.priority || 50}</td>
                    <td>${rule.discover_count || 0}</td>
                    <td>
                        <button class="action-btn" onclick="editSDKRule(${rule.id})" title="ç¼–è¾‘">âœï¸</button>
                        <button class="action-btn danger" onclick="deleteSDKRule(${rule.id})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
        }

        function formatCategory(category) {
            const categoryMap = {
                'analytics': 'æ•°æ®åˆ†æ',
                'ad': 'å¹¿å‘Š',
                'push': 'æ¨é€',
                'payment': 'æ”¯ä»˜',
                'social': 'ç¤¾äº¤åˆ†äº«',
                'multimedia': 'å¤šåª’ä½“',
                'other': 'å…¶ä»–'
            };
            return categoryMap[category] || category || 'N/A';
        }

        function formatSDKStatus(status) {
            const statusMap = {
                'active': 'æ´»è·ƒ',
                'pending': 'å¾…å®¡æ ¸',
                'disabled': 'å·²ç¦ç”¨'
            };
            return statusMap[status] || status || 'æœªçŸ¥';
        }

        function refreshSDKRules() {
            loadSDKRules();
        }

        function showAddSDKRuleModal() {
            document.getElementById('sdk-modal-title').textContent = 'æ·»åŠ  SDK è§„åˆ™';
            document.getElementById('sdk-rule-id').value = '';
            document.getElementById('sdk-domain').value = '';
            document.getElementById('sdk-category').value = '';
            document.getElementById('sdk-sub-category').value = '';
            document.getElementById('sdk-provider').value = '';
            document.getElementById('sdk-description').value = '';
            document.getElementById('sdk-confidence').value = '1.00';
            document.getElementById('sdk-priority').value = '50';
            document.getElementById('sdk-status').value = 'active';

            document.getElementById('sdk-rule-modal').style.display = 'flex';
        }

        async function editSDKRule(id) {
            const rule = allSDKRules.find(r => r.id === id);
            if (!rule) {
                alert('è§„åˆ™ä¸å­˜åœ¨');
                return;
            }

            document.getElementById('sdk-modal-title').textContent = 'ç¼–è¾‘ SDK è§„åˆ™';
            document.getElementById('sdk-rule-id').value = rule.id;
            document.getElementById('sdk-domain').value = rule.domain || '';
            document.getElementById('sdk-category').value = rule.category || '';
            document.getElementById('sdk-sub-category').value = rule.sub_category || '';
            document.getElementById('sdk-provider').value = rule.provider || '';
            document.getElementById('sdk-description').value = rule.description || '';
            document.getElementById('sdk-confidence').value = rule.confidence || 1.00;
            document.getElementById('sdk-priority').value = rule.priority || 50;
            document.getElementById('sdk-status').value = rule.status || 'active';

            document.getElementById('sdk-rule-modal').style.display = 'flex';
        }

        async function saveSDKRule() {
            const id = document.getElementById('sdk-rule-id').value;
            const domain = document.getElementById('sdk-domain').value;
            const category = document.getElementById('sdk-category').value;
            const subCategory = document.getElementById('sdk-sub-category').value;
            const provider = document.getElementById('sdk-provider').value;
            const description = document.getElementById('sdk-description').value;
            const confidence = parseFloat(document.getElementById('sdk-confidence').value);
            const priority = parseInt(document.getElementById('sdk-priority').value);
            const status = document.getElementById('sdk-status').value;

            if (!domain || !category || !provider) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }

            const data = {
                domain,
                category,
                sub_category: subCategory,
                provider,
                description,
                confidence,
                priority,
                status
            };

            try {
                let response;
                if (id) {
                    // Update existing rule
                    response = await fetch(`/api/sdk_rules/${id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new rule
                    response = await fetch('/api/sdk_rules', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    alert(id ? 'SDK è§„åˆ™æ›´æ–°æˆåŠŸ' : 'SDK è§„åˆ™æ·»åŠ æˆåŠŸ');
                    closeSDKRuleModal();
                    loadSDKRules();
                } else {
                    const error = await response.text();
                    alert(`ä¿å­˜å¤±è´¥: ${error}`);
                }
            } catch (error) {
                console.error('Failed to save SDK rule:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        async function deleteSDKRule(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ SDK è§„åˆ™å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/sdk_rules/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('SDK è§„åˆ™åˆ é™¤æˆåŠŸ');
                    loadSDKRules();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('Failed to delete SDK rule:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        function closeSDKRuleModal() {
            document.getElementById('sdk-rule-modal').style.display = 'none';
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('sdk-rule-modal');
            if (event.target === modal) {
                closeSDKRuleModal();
            }
            const uploadModal = document.getElementById('upload-modal');
            if (event.target === uploadModal) {
                closeUploadDialog();
            }
        });
    </script>

    <!-- APK Upload Modal -->
    <div id="upload-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; width: 90%; max-width: 700px; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 24px; border-bottom: 1px solid #F1F5F9;">
                <h2 style="font-size: 20px; font-weight: 600; color: #1E293B; margin: 0;">ğŸ“¤ æ‰¹é‡ä¸Šä¼  APK æ–‡ä»¶</h2>
                <button onclick="closeUploadDialog()" style="width: 36px; height: 36px; border-radius: 8px; border: none; background: #F1F5F9; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">âœ•</button>
            </div>
            <div style="padding: 24px; overflow-y: auto; max-height: calc(85vh - 180px);">
                <div style="margin-bottom: 20px;">
                    <label for="apk-file-input" style="display: block; margin-bottom: 10px; font-weight: 500;">
                        é€‰æ‹© APK æ–‡ä»¶ (æ”¯æŒæ‰¹é‡é€‰æ‹©ï¼Œæ¯ä¸ªæ–‡ä»¶æœ€å¤§ 500MBï¼Œæœ€å¤š 100 ä¸ª)
                    </label>
                    <input type="file" id="apk-file-input" accept=".apk" multiple
                           onchange="updateFileList()"
                           style="width: 100%; padding: 10px; border: 2px dashed #64748B; border-radius: 8px; cursor: pointer;">
                </div>

                <!-- Selected Files List -->
                <div id="selected-files-container" style="display: none; margin-bottom: 20px;">
                    <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 500;">å·²é€‰æ‹©çš„æ–‡ä»¶ (<span id="selected-files-count">0</span>ä¸ª)</span>
                        <button onclick="clearFileSelection()" style="padding: 4px 12px; border: 1px solid #EF4444; background: white; color: #EF4444; border-radius: 6px; cursor: pointer; font-size: 12px;">æ¸…ç©º</button>
                    </div>
                    <div id="selected-files-list" style="max-height: 150px; overflow-y: auto; background: #F8FAFC; border-radius: 8px; padding: 8px;">
                    </div>
                </div>

                <!-- Upload Progress -->
                <div id="upload-progress" style="display: none; margin-top: 20px;">
                    <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 500;">ä¸Šä¼ è¿›åº¦</span>
                        <span id="upload-progress-text" style="color: #3B82F6; font-weight: 600;">0%</span>
                    </div>
                    <div style="width: 100%; height: 24px; background-color: #E2E8F0; border-radius: 12px; overflow: hidden;">
                        <div id="upload-progress-bar"
                             style="height: 100%; width: 0%; background: linear-gradient(90deg, #3B82F6, #8B5CF6); transition: width 0.3s ease;">
                        </div>
                    </div>
                </div>

                <!-- Upload Results -->
                <div id="upload-results" style="display: none; margin-top: 20px;">
                    <div style="margin-bottom: 10px; font-weight: 500;">ä¸Šä¼ ç»“æœ</div>
                    <div id="upload-results-list" style="max-height: 200px; overflow-y: auto; background: #F8FAFC; border-radius: 8px; padding: 8px;">
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background-color: #F1F5F9; border-radius: 8px; border-left: 4px solid #3B82F6;">
                    <p style="margin: 0; font-size: 14px; color: #475569;">
                        <strong>æç¤º:</strong><br>
                        â€¢ åªæ”¯æŒ .apk æ ¼å¼æ–‡ä»¶<br>
                        â€¢ æ¯ä¸ªæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 500MB<br>
                        â€¢ æœ€å¤šåŒæ—¶ä¸Šä¼  100 ä¸ªæ–‡ä»¶<br>
                        â€¢ æŒ‰ä½ Ctrl (Windows) æˆ– Cmd (Mac) å¯å¤šé€‰æ–‡ä»¶<br>
                        â€¢ ä¸Šä¼ åç³»ç»Ÿå°†è‡ªåŠ¨å¼€å§‹åˆ†æ
                    </p>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; padding: 16px 24px; border-top: 1px solid #F1F5F9; background: #F8FAFC;">
                <button onclick="closeUploadDialog()"
                        style="padding: 10px 20px; border: 1px solid #CBD5E1; background: white; color: #475569; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                    å–æ¶ˆ
                </button>
                <button id="upload-btn" onclick="uploadAPK()"
                        style="padding: 10px 20px; border: none; background: linear-gradient(135deg, #3B82F6, #8B5CF6); color: white; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                    ğŸ“¤ å¼€å§‹ä¸Šä¼ 
                </button>
            </div>
        </div>
    </div>

    <style>
        #apk-file-input:hover {
            border-color: #3B82F6;
            background-color: #F8FAFC;
        }

        #apk-file-input::file-selector-button {
            padding: 8px 16px;
            border: none;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-right: 10px;
        }

        #apk-file-input::file-selector-button:hover {
            opacity: 0.9;
        }
    </style>
</body>
</html>
