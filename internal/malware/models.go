package malware

import (
	"time"

	"gorm.io/gorm"
)

// DetectionStatus 检测状态
type DetectionStatus string

const (
	DetectionStatusPending   DetectionStatus = "pending"
	DetectionStatusRunning   DetectionStatus = "running"
	DetectionStatusCompleted DetectionStatus = "completed"
	DetectionStatusFailed    DetectionStatus = "failed"
	DetectionStatusSkipped   DetectionStatus = "skipped"
)

// MalwareFamily 恶意软件家族 (15分类)
type MalwareFamily string

const (
	FamilyBenign       MalwareFamily = "Benign"
	FamilyAdware       MalwareFamily = "Adware"
	FamilyBackdoor     MalwareFamily = "Backdoor"
	FamilyBanker       MalwareFamily = "Banker"
	FamilyDropper      MalwareFamily = "Dropper"
	FamilyFileInfector MalwareFamily = "FileInfector"
	FamilyPUA          MalwareFamily = "PUA"
	FamilyRansomware   MalwareFamily = "Ransomware"
	FamilyRiskware     MalwareFamily = "Riskware"
	FamilyScareware    MalwareFamily = "Scareware"
	FamilySMS          MalwareFamily = "SMS"
	FamilySpy          MalwareFamily = "Spy"
	FamilyTrojan       MalwareFamily = "Trojan"
	FamilyVirus        MalwareFamily = "Virus"
	FamilyZeroday      MalwareFamily = "Zeroday"
)

// AllMalwareFamilies 所有恶意软件家族列表
var AllMalwareFamilies = []MalwareFamily{
	FamilyBenign,
	FamilyAdware,
	FamilyBackdoor,
	FamilyBanker,
	FamilyDropper,
	FamilyFileInfector,
	FamilyPUA,
	FamilyRansomware,
	FamilyRiskware,
	FamilyScareware,
	FamilySMS,
	FamilySpy,
	FamilyTrojan,
	FamilyVirus,
	FamilyZeroday,
}

// DetectionRequest 检测请求
type DetectionRequest struct {
	APKPath         string            `json:"apk_path"`
	UnpackedDexPath string            `json:"unpacked_dex_path,omitempty"`
	TaskID          string            `json:"task_id,omitempty"`
	Models          []string          `json:"models"`
	Options         DetectionOptions  `json:"options"`
}

// DetectionOptions 检测选项
type DetectionOptions struct {
	ExtractGraphFeatures    bool `json:"extract_graph_features"`
	ExtractTemporalFeatures bool `json:"extract_temporal_features"`
	UseEnsemble             bool `json:"use_ensemble"`
}

// DetectionResponse 检测响应
type DetectionResponse struct {
	Success          bool             `json:"success"`
	TaskID           string           `json:"task_id,omitempty"`
	DetectionResults *DetectionResult `json:"detection_results,omitempty"`
	Error            string           `json:"error,omitempty"`
	ErrorType        string           `json:"error_type,omitempty"`
}

// DetectionResult 检测结果
type DetectionResult struct {
	// 主要结果
	IsMalware           bool    `json:"is_malware"`
	Confidence          float64 `json:"confidence"`
	MalwareProbability  float64 `json:"malware_probability,omitempty"`
	BenignProbability   float64 `json:"benign_probability,omitempty"`

	// 15分类结果
	PredictedFamily     string              `json:"predicted_family,omitempty"`
	FamilyProbabilities []FamilyProbability `json:"family_probabilities,omitempty"`
	TopKPredictions     []FamilyProbability `json:"top_k_predictions,omitempty"`

	// 各模型结果
	DrebinResult      *ModelResult `json:"drebin_result,omitempty"`
	MH100KResult      *ModelResult `json:"mh100k_result,omitempty"`
	CICMalDroidResult *ModelResult `json:"cicmaldroid_result,omitempty"`

	// 集成结果
	EnsembleResult *EnsembleResult `json:"ensemble_result,omitempty"`

	// 特征信息
	FeatureSource  string          `json:"feature_source"`
	FeatureSummary *FeatureSummary `json:"feature_summary,omitempty"`

	// 使用的模型
	ModelsUsed []string `json:"models_used,omitempty"`

	// 性能指标
	ExtractionTimeMs int `json:"extraction_time_ms,omitempty"`
	InferenceTimeMs  int `json:"inference_time_ms,omitempty"`
	TotalTimeMs      int `json:"total_time_ms,omitempty"`

	// 错误信息
	Errors []string `json:"errors,omitempty"`
}

// ModelResult 单个模型的结果
type ModelResult struct {
	IsMalware           bool                `json:"is_malware"`
	PredictedClass      int                 `json:"predicted_class"`
	Confidence          float64             `json:"confidence"`
	MalwareProbability  float64             `json:"malware_probability,omitempty"`
	BenignProbability   float64             `json:"benign_probability,omitempty"`
	PredictedFamily     string              `json:"predicted_family,omitempty"`
	FamilyProbabilities []FamilyProbability `json:"family_probabilities,omitempty"`
	TopKPredictions     []FamilyProbability `json:"top_k_predictions,omitempty"`
}

// FamilyProbability 家族概率
type FamilyProbability struct {
	Family      string  `json:"family"`
	Probability float64 `json:"probability"`
}

// EnsembleResult 集成预测结果
type EnsembleResult struct {
	IsMalware     bool               `json:"is_malware"`
	Confidence    float64            `json:"confidence"`
	EnsembleScore float64            `json:"ensemble_score"`
	VotingDetails map[string]float64 `json:"voting_details,omitempty"`
	Error         string             `json:"error,omitempty"`
}

// FeatureSummary 特征摘要
type FeatureSummary struct {
	StaticFeatures *StaticFeatureSummary `json:"static_features,omitempty"`
	GraphFeatures  *GraphFeatureSummary  `json:"graph_features,omitempty"`
}

// StaticFeatureSummary 静态特征摘要
type StaticFeatureSummary struct {
	DangerousPermissions int `json:"dangerous_permissions"`
	SuspiciousIntents    int `json:"suspicious_intents"`
	SensitiveAPIs        int `json:"sensitive_apis"`
	TotalFeatures        int `json:"total_features"`
}

// GraphFeatureSummary 图特征摘要
type GraphFeatureSummary struct {
	NumNodes  int     `json:"num_nodes"`
	NumEdges  int     `json:"num_edges"`
	AvgDegree float64 `json:"avg_degree"`
}

// HealthResponse 健康检查响应
type HealthResponse struct {
	Status          string   `json:"status"`
	ModelsLoaded    bool     `json:"models_loaded"`
	AvailableModels []string `json:"available_models"`
	Device          string   `json:"device"`
	ModelDir        string   `json:"model_dir"`
	Error           string   `json:"error,omitempty"`
}

// ModelsResponse 模型列表响应
type ModelsResponse struct {
	Models     []string              `json:"models"`
	ModelsInfo map[string]*ModelInfo `json:"models_info,omitempty"`
}

// ModelInfo 模型信息
type ModelInfo struct {
	Path       string   `json:"path"`
	Type       string   `json:"type"`
	Accuracy   float64  `json:"accuracy,omitempty"`
	InputDim   int      `json:"input_dim"`
	NumClasses int      `json:"num_classes"`
	Families   []string `json:"families,omitempty"`
}

// TaskMalwareResult 任务恶意检测结果 (数据库模型)
type TaskMalwareResult struct {
	ID uint `gorm:"primaryKey;autoIncrement" json:"id"`

	// 关联任务
	TaskID string `gorm:"type:varchar(36);uniqueIndex:uk_task_id;not null" json:"task_id"`
	APKName string `gorm:"->;column:apk_name" json:"apk_name,omitempty"`

	// 检测状态
	Status DetectionStatus `gorm:"type:varchar(30);not null;default:'pending';index:idx_status" json:"status"`

	// 主要结果 (Drebin 模型)
	IsMalware          bool    `gorm:"default:false;index:idx_is_malware" json:"is_malware"`
	Confidence         float64 `gorm:"type:decimal(5,4)" json:"confidence"`
	MalwareProbability float64 `gorm:"type:decimal(5,4)" json:"malware_probability,omitempty"`
	BenignProbability  float64 `gorm:"type:decimal(5,4)" json:"benign_probability,omitempty"`

	// 15分类结果 (CICMalDroid)
	PredictedFamily     string `gorm:"type:varchar(50);index:idx_predicted_family" json:"predicted_family,omitempty"`
	FamilyProbabilities string `gorm:"type:json" json:"family_probabilities,omitempty"` // JSON 格式

	// 使用的模型
	ModelsUsed string `gorm:"type:json" json:"models_used,omitempty"` // JSON 数组

	// 各模型详细结果
	DrebinResult      string `gorm:"column:drebin_result;type:json" json:"drebin_result,omitempty"`
	MH100KResult      string `gorm:"column:mh100_k_result;type:json" json:"mh100k_result,omitempty"`
	CICMalDroidResult string `gorm:"column:cic_mal_droid_result;type:json" json:"cicmaldroid_result,omitempty"`

	// 集成结果
	EnsembleResult string `gorm:"type:json" json:"ensemble_result,omitempty"`

	// 特征信息
	FeatureSummary string `gorm:"type:json" json:"feature_summary,omitempty"`
	FeatureSource  string `gorm:"type:varchar(20)" json:"feature_source,omitempty"` // original / unpacked

	// 性能指标
	ExtractionTimeMs int `gorm:"type:int" json:"extraction_time_ms,omitempty"`
	InferenceTimeMs  int `gorm:"type:int" json:"inference_time_ms,omitempty"`
	TotalTimeMs      int `gorm:"type:int" json:"total_time_ms,omitempty"`

	// 错误信息
	ErrorMessage string `gorm:"type:text" json:"error_message,omitempty"`

	// 时间戳
	DetectedAt *time.Time `gorm:"index:idx_detected_at" json:"detected_at,omitempty"`
	CreatedAt  time.Time  `gorm:"not null;index:idx_created_at" json:"created_at"`
}

// TableName 设置表名
func (TaskMalwareResult) TableName() string {
	return "task_malware_results"
}

// BeforeSave 保存前设置 JSON 字段默认值
func (r *TaskMalwareResult) BeforeSave(tx *gorm.DB) error {
	// MySQL JSON 列不接受空字符串，需要设置默认值
	if r.FamilyProbabilities == "" {
		r.FamilyProbabilities = "[]"
	}
	if r.ModelsUsed == "" {
		r.ModelsUsed = "[]"
	}
	if r.DrebinResult == "" {
		r.DrebinResult = "null"
	}
	if r.MH100KResult == "" {
		r.MH100KResult = "null"
	}
	if r.CICMalDroidResult == "" {
		r.CICMalDroidResult = "null"
	}
	if r.EnsembleResult == "" {
		r.EnsembleResult = "null"
	}
	if r.FeatureSummary == "" {
		r.FeatureSummary = "null"
	}
	return nil
}

// MalwareStatistics 恶意检测统计
type MalwareStatistics struct {
	TotalScanned     int64                     `json:"total_scanned"`
	MalwareCount     int64                     `json:"malware_count"`
	BenignCount      int64                     `json:"benign_count"`
	MalwareRate      float64                   `json:"malware_rate"`
	AvgConfidence    float64                   `json:"avg_confidence"`
	AvgDetectionTime float64                   `json:"avg_detection_time_ms"`
	FamilyBreakdown  []FamilyBreakdownItem     `json:"family_breakdown,omitempty"`
	ConfidenceDist   *ConfidenceDistribution   `json:"confidence_distribution,omitempty"`
}

// FamilyBreakdownItem 家族分布项
type FamilyBreakdownItem struct {
	Family     string  `json:"family"`
	Count      int64   `json:"count"`
	Percentage float64 `json:"percentage"`
}

// ConfidenceDistribution 置信度分布
type ConfidenceDistribution struct {
	HighConfidence   int64 `json:"high_confidence"`   // > 0.9
	MediumConfidence int64 `json:"medium_confidence"` // 0.7 - 0.9
	LowConfidence    int64 `json:"low_confidence"`    // < 0.7
}
