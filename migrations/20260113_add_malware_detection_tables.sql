-- =====================================================
-- 恶意检测结果表
-- 创建日期: 2026-01-13
-- 说明: 存储 APK 恶意检测结果
-- =====================================================

-- 创建恶意检测结果表
CREATE TABLE IF NOT EXISTS task_malware_results (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '主键ID',
    task_id VARCHAR(36) NOT NULL COMMENT '关联任务ID',

    -- 检测状态
    status VARCHAR(30) NOT NULL DEFAULT 'pending' COMMENT '检测状态: pending/running/completed/failed/skipped',

    -- 主要结果 (Drebin 模型)
    is_malware BOOLEAN DEFAULT FALSE COMMENT '是否为恶意软件',
    confidence DECIMAL(5,4) DEFAULT NULL COMMENT '置信度 0.0000-1.0000',
    malware_probability DECIMAL(5,4) DEFAULT NULL COMMENT '恶意概率',
    benign_probability DECIMAL(5,4) DEFAULT NULL COMMENT '良性概率',

    -- 15分类结果 (CICMalDroid)
    predicted_family VARCHAR(50) DEFAULT NULL COMMENT '预测的恶意家族',
    family_probabilities JSON DEFAULT NULL COMMENT '家族概率分布 JSON',

    -- 使用的模型
    models_used JSON DEFAULT NULL COMMENT '使用的模型列表',

    -- 各模型详细结果
    drebin_result JSON DEFAULT NULL COMMENT 'Drebin模型结果',
    mh100k_result JSON DEFAULT NULL COMMENT 'MH-100K模型结果',
    cicmaldroid_result JSON DEFAULT NULL COMMENT 'CICMalDroid模型结果',

    -- 集成结果
    ensemble_result JSON DEFAULT NULL COMMENT '集成预测结果',

    -- 特征信息
    feature_summary JSON DEFAULT NULL COMMENT '特征摘要',
    feature_source VARCHAR(20) DEFAULT NULL COMMENT '特征来源: original/unpacked',

    -- 性能指标
    extraction_time_ms INT DEFAULT NULL COMMENT '特征提取耗时(毫秒)',
    inference_time_ms INT DEFAULT NULL COMMENT '模型推理耗时(毫秒)',
    total_time_ms INT DEFAULT NULL COMMENT '总耗时(毫秒)',

    -- 错误信息
    error_message TEXT DEFAULT NULL COMMENT '错误信息',

    -- 时间戳
    detected_at TIMESTAMP NULL DEFAULT NULL COMMENT '检测完成时间',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    -- 索引
    UNIQUE KEY uk_task_id (task_id),
    INDEX idx_status (status),
    INDEX idx_is_malware (is_malware),
    INDEX idx_predicted_family (predicted_family),
    INDEX idx_detected_at (detected_at),
    INDEX idx_created_at (created_at),

    -- 外键约束
    CONSTRAINT fk_malware_task_id FOREIGN KEY (task_id)
        REFERENCES apk_tasks(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='任务恶意检测结果表';


-- =====================================================
-- 创建统计视图
-- =====================================================

-- 恶意检测统计视图
CREATE OR REPLACE VIEW v_malware_statistics AS
SELECT
    COUNT(*) AS total_scanned,
    SUM(CASE WHEN is_malware = TRUE THEN 1 ELSE 0 END) AS malware_count,
    SUM(CASE WHEN is_malware = FALSE THEN 1 ELSE 0 END) AS benign_count,
    ROUND(SUM(CASE WHEN is_malware = TRUE THEN 1 ELSE 0 END) * 100.0 / NULLIF(COUNT(*), 0), 2) AS malware_rate,
    ROUND(AVG(confidence), 4) AS avg_confidence,
    ROUND(AVG(total_time_ms), 2) AS avg_detection_time_ms
FROM task_malware_results
WHERE status = 'completed';


-- 恶意家族分布视图
CREATE OR REPLACE VIEW v_malware_family_distribution AS
SELECT
    predicted_family AS family,
    COUNT(*) AS count,
    ROUND(COUNT(*) * 100.0 / (
        SELECT COUNT(*) FROM task_malware_results
        WHERE is_malware = TRUE AND status = 'completed'
    ), 2) AS percentage
FROM task_malware_results
WHERE is_malware = TRUE
  AND predicted_family IS NOT NULL
  AND predicted_family != ''
  AND status = 'completed'
GROUP BY predicted_family
ORDER BY count DESC;


-- 置信度分布视图
CREATE OR REPLACE VIEW v_malware_confidence_distribution AS
SELECT
    SUM(CASE WHEN confidence > 0.9 THEN 1 ELSE 0 END) AS high_confidence,
    SUM(CASE WHEN confidence BETWEEN 0.7 AND 0.9 THEN 1 ELSE 0 END) AS medium_confidence,
    SUM(CASE WHEN confidence < 0.7 THEN 1 ELSE 0 END) AS low_confidence
FROM task_malware_results
WHERE status = 'completed';


-- =====================================================
-- 打印完成信息
-- =====================================================
SELECT 'Migration completed: task_malware_results table created' AS message;
