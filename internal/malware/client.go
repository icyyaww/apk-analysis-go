package malware

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"time"

	"github.com/sirupsen/logrus"
)

// Client 恶意检测服务客户端
type Client struct {
	baseURL    string
	httpClient *http.Client
	logger     *logrus.Logger
}

// ClientConfig 客户端配置
type ClientConfig struct {
	ServerURL string        // 推理服务地址
	Timeout   time.Duration // 请求超时时间
}

// DefaultClientConfig 默认客户端配置
func DefaultClientConfig() *ClientConfig {
	return &ClientConfig{
		ServerURL: "http://localhost:5000",
		Timeout:   120 * time.Second,
	}
}

// NewClient 创建恶意检测客户端
func NewClient(cfg *ClientConfig, logger *logrus.Logger) *Client {
	if cfg == nil {
		cfg = DefaultClientConfig()
	}
	if logger == nil {
		logger = logrus.New()
	}

	return &Client{
		baseURL: cfg.ServerURL,
		httpClient: &http.Client{
			Timeout: cfg.Timeout,
		},
		logger: logger,
	}
}

// Health 健康检查
func (c *Client) Health(ctx context.Context) (*HealthResponse, error) {
	url := fmt.Sprintf("%s/api/v1/health", c.baseURL)

	req, err := http.NewRequestWithContext(ctx, http.MethodGet, url, nil)
	if err != nil {
		return nil, fmt.Errorf("create request failed: %w", err)
	}

	resp, err := c.httpClient.Do(req)
	if err != nil {
		return nil, fmt.Errorf("request failed: %w", err)
	}
	defer resp.Body.Close()

	body, err := io.ReadAll(resp.Body)
	if err != nil {
		return nil, fmt.Errorf("read response failed: %w", err)
	}

	var health HealthResponse
	if err := json.Unmarshal(body, &health); err != nil {
		return nil, fmt.Errorf("parse response failed: %w", err)
	}

	return &health, nil
}

// ListModels 获取可用模型列表
func (c *Client) ListModels(ctx context.Context) (*ModelsResponse, error) {
	url := fmt.Sprintf("%s/api/v1/models", c.baseURL)

	req, err := http.NewRequestWithContext(ctx, http.MethodGet, url, nil)
	if err != nil {
		return nil, fmt.Errorf("create request failed: %w", err)
	}

	resp, err := c.httpClient.Do(req)
	if err != nil {
		return nil, fmt.Errorf("request failed: %w", err)
	}
	defer resp.Body.Close()

	body, err := io.ReadAll(resp.Body)
	if err != nil {
		return nil, fmt.Errorf("read response failed: %w", err)
	}

	var models ModelsResponse
	if err := json.Unmarshal(body, &models); err != nil {
		return nil, fmt.Errorf("parse response failed: %w", err)
	}

	return &models, nil
}

// Detect 执行恶意检测
func (c *Client) Detect(ctx context.Context, request *DetectionRequest) (*DetectionResponse, error) {
	url := fmt.Sprintf("%s/api/v1/detect", c.baseURL)

	// 默认模型
	if len(request.Models) == 0 {
		request.Models = []string{"drebin"}
	}

	reqBody, err := json.Marshal(request)
	if err != nil {
		return nil, fmt.Errorf("marshal request failed: %w", err)
	}

	c.logger.WithFields(logrus.Fields{
		"apk_path": request.APKPath,
		"task_id":  request.TaskID,
		"models":   request.Models,
	}).Debug("Sending detection request")

	req, err := http.NewRequestWithContext(ctx, http.MethodPost, url, bytes.NewReader(reqBody))
	if err != nil {
		return nil, fmt.Errorf("create request failed: %w", err)
	}
	req.Header.Set("Content-Type", "application/json")

	startTime := time.Now()
	resp, err := c.httpClient.Do(req)
	if err != nil {
		return nil, fmt.Errorf("request failed: %w", err)
	}
	defer resp.Body.Close()

	duration := time.Since(startTime)

	body, err := io.ReadAll(resp.Body)
	if err != nil {
		return nil, fmt.Errorf("read response failed: %w", err)
	}

	var detection DetectionResponse
	if err := json.Unmarshal(body, &detection); err != nil {
		return nil, fmt.Errorf("parse response failed: %w, body: %s", err, string(body))
	}

	if !detection.Success {
		c.logger.WithFields(logrus.Fields{
			"error":      detection.Error,
			"error_type": detection.ErrorType,
			"duration":   duration,
		}).Warn("Detection failed")
		return &detection, nil
	}

	if detection.DetectionResults != nil {
		c.logger.WithFields(logrus.Fields{
			"is_malware":  detection.DetectionResults.IsMalware,
			"confidence":  detection.DetectionResults.Confidence,
			"family":      detection.DetectionResults.PredictedFamily,
			"duration_ms": detection.DetectionResults.TotalTimeMs,
		}).Info("Detection completed")
	}

	return &detection, nil
}

// IsAvailable 检查服务是否可用
func (c *Client) IsAvailable(ctx context.Context) bool {
	health, err := c.Health(ctx)
	if err != nil {
		c.logger.WithError(err).Warn("Malware detection service unavailable")
		return false
	}

	return health.Status == "healthy" && health.ModelsLoaded
}

// GetAvailableModels 获取可用模型名称列表
func (c *Client) GetAvailableModels(ctx context.Context) ([]string, error) {
	models, err := c.ListModels(ctx)
	if err != nil {
		return nil, err
	}
	return models.Models, nil
}
